<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>History and versioning &mdash; Plone Community Managed Developer Manual v1.0 documentation</title>
    <link rel="stylesheet" href="../_static/plone.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Plone Community Managed Developer Manual v1.0 documentation" href="../index.html" />
    <link rel="up" title="Content management" href="index.html" />
    <link rel="next" title="Import and export" href="importexport.html" />
    <link rel="prev" title="Behaviors" href="behaviors.html" />
<script language="javascript">
//<![CDATA[

Documentation.addTranslations({"locale": "fr", "plural_expr": "(n > 1)", "messages": {"See the definition": "Voir la d\u00e9finition"}});

// See http://disqus.disqus.com/general_integration_help/
var disqus_developer = 1;
if (document.location.protocol == 'http:') {
    disqus_developer = 0;
}

// Some HTML/CSS transforms we can't do in pure CSS (waiting for CSS3 support)
$(document).ready(function () {

    // Style of .. verisonmodified:: , .. versionadded:: ...
    $('p:has(span.versionmodified)').addClass('p-versionmodified');

    // Style of the TOC tree
    $('ul:has(li.toctree-l1)').addClass('toctree');

    // Decorate links to other sites
    $('a[class~=external]').attr('target', '_blank');

    // Glossary terms
    $('em.xref').attr('title', _('See the definition'));

    // We need to have all <pre> in a <div class="highlight"> to mimic pygments
    // to work around a pygments (?) bug
    var suffixes = {cfg: null, python:null};
    for (var suffix in suffixes) {
        var pattern = 'div.highlight-' + suffix + ' > pre';
        $(pattern).wrap('<div class="highlight" />');
    }
    return true;
});
//]]>
</script>

  </head>
  <body>
<!--[if lte IE 6]>
<style type="text/css">
#ie6msg{border:3px solid #090; margin:8px 0; background:#cfc; color:#000;}
#ie6msg h4{margin:8px; padding:0;}
#ie6msg p{margin:8px; padding:0;}
#ie6msg p a.getie8{font-weight:bold; color:#006;}
#ie6msg p a.ie6expl{font-weight:normal; color:#006;}
</style>
<div id="ie6msg">
<h4>Did you know that your browser is out of date?</h4>
<p>If the layout of this site seems ugly, that's because you're actually using
an outdated browser. And we wont put any effort to provide a nice layout to IE6
users.</p>
<p>To get the best possible experience using our website we recommend that you
upgrade your browser to a newer version. The current version
is <a class="getie8"
href="http://upgradeie.s3.amazonaws.com/eng/index.html">Internet Explorer
8</a>. The upgrade is free. If you're using a PC at work you should contact your
IT administrator.</p>
<p>If you want to you may also try some other popular Internet browsers
like <a class="ie6expl"
href="http://getfirefox.com">Firefox</a>, <a class="ie6expl"
href="http://www.google.com/chrome">Chrome</a>, <a class="ie6expl"
href="http://www.opera.com">Opera</a>, or <a class="ie6expl"
href="http://www.apple.com/safari/download/">Safari</a></p>
</div>
<![endif]-->

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="importexport.html" title="Import and export"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="behaviors.html" title="Behaviors"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Content management</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="sphinx-content">
    <div class="section" id="history-and-versioning">
<h1>History and versioning<a class="headerlink" href="#history-and-versioning" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#enabling-versioning-on-your-custom-content-type" id="id2">Enabling versioning on your custom content type</a></li>
<li><a class="reference internal" href="#checking-whether-versioning-is-enabled" id="id3">Checking whether versioning is enabled</a></li>
<li><a class="reference internal" href="#inspecting-versioning-policies" id="id4">Inspecting versioning policies</a></li>
<li><a class="reference internal" href="#how-versioning-cmfeditions-works" id="id5">How versioning (CMFEditions) works</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Plone versioning allows you to go back between older edits of the same content object.</p>
<p><a class="reference external" href="http://plone.org/documentation/manual/plone-3-user-manual/managing-content/versioning-plone-v3.0-plone-v3.2">Versioning allows you to restore and diff previous copies of the same content</a>.
More about <a class="reference external" href="http://plone.org/products/cmfeditions/documentation/refmanual/cmfeditionoverview">CMFEditions here</a>.</p>
<p>See also</p>
<ul class="simple">
<li><a class="reference external" href="http://www.uwosh.edu/ploneprojects/documentation/how-tos/how-to-enable-versioning-history-for-a-custom-content-type">Versioning tutorial for custom content types</a>.</li>
</ul>
</div>
<div class="section" id="enabling-versioning-on-your-custom-content-type">
<h2><a class="toc-backref" href="#id2">Enabling versioning on your custom content type</a><a class="headerlink" href="#enabling-versioning-on-your-custom-content-type" title="Permalink to this headline">¶</a></h2>
<p>By default, version history is not enabled for custom content types.
Below are some notes how to enable it.</p>
<ul>
<li><p class="first">Inherit HistoryAwareMixin in your content type class:</p>
<div class="highlight-python"><pre>from Products.ATContentTypes.lib.historyaware import HistoryAwareMixin

..

class CustomContent(base.ATCTContent, HistoryAwareMixin):</pre>
</div>
</li>
<li><p class="first">Add versioning migration code to your setuphandlers.py / custom import steps:</p>
<div class="highlight-python"><pre>from Products.CMFCore.utils import getToolByName
from Products.CMFEditions.setuphandlers import VERSIONING_ACTIONS, ADD_POLICIES, DEFAULT_POLICIES

class DPSetup(object):

    def configureVersioning(self,portal):
       """
       Importing various settings
       Big thanks to amir toole from plone-users
       """

       for versioning_actions in ('MyositisPatient','MyositisVisit','MyositisOrdination','MyositisSeriousadverseevent','MyositisAdhoc','MyositisAdhoc1','MyositisAdhoc2','MyositisAdhoc3','MyositisAdhoc4'):
        VERSIONING_ACTIONS[versioning_actions] = 'version_document_view'
        portal_repository = getToolByName(portal, 'portal_repository')
        portal_repository.setAutoApplyMode(True)
        portal_repository.setVersionableContentTypes(VERSIONING_ACTIONS.keys())
        portal_repository._migrateVersionPolicies()
        portal_repository.manage_changePolicyDefs(ADD_POLICIES)
        for ctype in VERSIONING_ACTIONS:
         for policy_id in DEFAULT_POLICIES:
             portal_repository.addPolicyForContentType(ctype, policy_id)

  ...

  def importFinalSteps(context):
    """
    The last bit of code that runs as part of this setup profile.
    """
    site = context.getSite()
    configurator = DPSetup()
    configurator.configureVersioning(site)</pre>
</div>
</li>
<li><p class="first">To see which fields differ between versions, diff tool must be configured to support your custom content types.
GenericSetup support is available after Plone 3.2. For older you must manually create entries in portal_diff_tool.
Example GenericSetup difftool.xml:</p>
<div class="highlight-python"><pre>&lt;?xml version="1.0"?&gt;

&lt;object&gt;

  &lt;difftypes&gt;
      &lt;type portal_type="Presentation"&gt;
        &lt;!-- Field any will match all field names, otherwise you need to specify the field name in schema --&gt;
        &lt;field name="any" difftype="Compound Diff for AT types"/&gt;
      &lt;/type&gt;
  &lt;/difftypes&gt;
&lt;/object&gt;</pre>
</div>
</li>
<li><p class="first">If you have customized the edit process of your content type,
make sure that your edit action traverses to update_version_before_edit.cpt. For hints how to do this,
see portal_form_controller actions     . Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">## Script (Python) &quot;diagnose_content_edit&quot;</span>
<span class="c">##title=Custom editing script for diagnose content type</span>
<span class="c">##bind container=container</span>
<span class="c">##bind context=context</span>
<span class="c">##bind namespace=</span>
<span class="c">##bind script=script</span>
<span class="c">##bind state=state</span>
<span class="c">##bind subpath=traverse_subpath</span>
<span class="c">##parameters=id=&#39;&#39;</span>
<span class="c">##</span>

<span class="n">context</span><span class="o">.</span><span class="n">plone_log</span><span class="p">(</span><span class="s">&quot;Diagnose edit by doctor&quot;</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># TODO:</span>
<span class="c"># No freaking idea which of the update_version handlers is supposed to be run and when</span>
<span class="c">#</span>

<span class="c"># Run versioning support code</span>
<span class="c"># context.update_version_before_edit()</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">content_edit_impl</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>

<span class="c"># Run versioning support code</span>
<span class="n">context</span><span class="o">.</span><span class="n">update_version_on_edit</span><span class="p">()</span>

<span class="n">context</span><span class="o">.</span><span class="n">plone_log</span><span class="p">(</span><span class="s">&quot;Done&quot;</span><span class="p">)</span>


<span class="c"># Automatically trigger the workflow state change on edit</span>
<span class="n">context</span><span class="o">.</span><span class="n">portal_workflow</span><span class="o">.</span><span class="n">doActionFor</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&quot;push_to_review&quot;</span><span class="p">)</span>

<span class="k">return</span> <span class="n">state</span>
</pre></div>
</div>
</li>
<li><p class="first">If you are using custom roles you need to have at least CMFEditions: Save new version
permission enabled for the roles or you'll get exception:</p>
<div class="highlight-python"><pre>...

* Module Products.PythonScripts.PythonScript, line 327, in _exec
* Module None, line 36, in update_version_before_edit
  &lt;ControllerPythonScript at /xxx/update_version_before_edit used for /xxx/yyy&gt;
  Line 36
* Module Products.CMFEditions.CopyModifyMergeRepositoryTool, line 287, in save
* Module Products.CMFEditions.CopyModifyMergeRepositoryTool, line 408, in _assertAuthorized

Unauthorized: You are not allowed to access 'save' in this context</pre>
</div>
</li>
</ul>
<p>For more information</p>
<ul class="simple">
<li><a class="reference external" href="http://plone.org/documentation/manual/developer-manual/archetypes/appendix-practicals/enabling-versioning-on-your-custom-content-types">http://plone.org/documentation/manual/developer-manual/archetypes/appendix-practicals/enabling-versioning-on-your-custom-content-types</a></li>
</ul>
</div>
<div class="section" id="checking-whether-versioning-is-enabled">
<h2><a class="toc-backref" href="#id3">Checking whether versioning is enabled</a><a class="headerlink" href="#checking-whether-versioning-is-enabled" title="Permalink to this headline">¶</a></h2>
<p>The following check is performed by update_versioning_before_edit and update_versioning_on_edit scripts:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">pr</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portal_repository</span>

<span class="n">isVersionable</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">isVersionable</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="k">if</span> <span class="n">pr</span><span class="o">.</span><span class="n">supportsPolicy</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;at_edit_autoversion&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isVersionable</span><span class="p">:</span>
    <span class="c"># Versioning should work</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c"># Something is wrong....</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="inspecting-versioning-policies">
<h2><a class="toc-backref" href="#id4">Inspecting versioning policies</a><a class="headerlink" href="#inspecting-versioning-policies" title="Permalink to this headline">¶</a></h2>
<p>Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">portal_repository</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">portal_repository</span>
<span class="nb">map</span> <span class="o">=</span> <span class="n">portal_repository</span><span class="o">.</span><span class="n">getPolicyMap</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="k">print</span> <span class="n">i</span>
</pre></div>
</div>
<p>Will output (inc. some custom content types):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="s">&#39;File Disease Description&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;at_edit_autoversion&#39;</span><span class="p">,</span> <span class="s">&#39;version_on_revert&#39;</span><span class="p">])</span>
<span class="p">(</span><span class="s">&#39;Document&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;at_edit_autoversion&#39;</span><span class="p">,</span> <span class="s">&#39;version_on_revert&#39;</span><span class="p">])</span>
<span class="p">(</span><span class="s">&#39;Free Text Disease Description&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;at_edit_autoversion&#39;</span><span class="p">,</span> <span class="s">&#39;version_on_revert&#39;</span><span class="p">])</span>
<span class="p">(</span><span class="s">&#39;ATDocument&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;at_edit_autoversion&#39;</span><span class="p">,</span> <span class="s">&#39;version_on_revert&#39;</span><span class="p">])</span>
<span class="p">(</span><span class="s">&#39;Diagnose Description&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;at_edit_autoversion&#39;</span><span class="p">,</span> <span class="s">&#39;version_on_revert&#39;</span><span class="p">])</span>
<span class="p">(</span><span class="s">&#39;ATNewsItem&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;at_edit_autoversion&#39;</span><span class="p">,</span> <span class="s">&#39;version_on_revert&#39;</span><span class="p">])</span>
<span class="p">(</span><span class="s">&#39;Link&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;at_edit_autoversion&#39;</span><span class="p">,</span> <span class="s">&#39;version_on_revert&#39;</span><span class="p">])</span>
<span class="p">(</span><span class="s">&#39;News Item&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;at_edit_autoversion&#39;</span><span class="p">,</span> <span class="s">&#39;version_on_revert&#39;</span><span class="p">])</span>
<span class="p">(</span><span class="s">&#39;Event&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;at_edit_autoversion&#39;</span><span class="p">,</span> <span class="s">&#39;version_on_revert&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="how-versioning-cmfeditions-works">
<h2><a class="toc-backref" href="#id5">How versioning (CMFEditions) works</a><a class="headerlink" href="#how-versioning-cmfeditions-works" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://svn.zope.de/plone.org/collective/Products.CMFEditions/trunk/doc/DevelDoc.html">http://svn.zope.de/plone.org/collective/Products.CMFEditions/trunk/doc/DevelDoc.html</a></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You might actually want to check out the package to get your web browser to
properly read the file.</p>
</div>
</div>
</div>

  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<p class="logo"><a href="../index.html"><img src="../_static/plone-icon-64.png" />
</a></p>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">History and versioning</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#enabling-versioning-on-your-custom-content-type">Enabling versioning on your custom content type</a></li>
<li><a class="reference internal" href="#checking-whether-versioning-is-enabled">Checking whether versioning is enabled</a></li>
<li><a class="reference internal" href="#inspecting-versioning-policies">Inspecting versioning policies</a></li>
<li><a class="reference internal" href="#how-versioning-cmfeditions-works">How versioning (CMFEditions) works</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="behaviors.html"
                        title="previous chapter">Behaviors</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="importexport.html"
                        title="next chapter">Import and export</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/content/history.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="importexport.html" title="Import and export"
             >next</a> |</li>
        <li class="right" >
          <a href="behaviors.html" title="Behaviors"
             >previous</a> |</li>
        <li><a href="../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Content management</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2010 mFabrik Research Oy and Plone community contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>


  </body>
</html>