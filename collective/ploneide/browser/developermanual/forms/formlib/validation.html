<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Adding validation &mdash; Plone Community Managed Developer Manual v1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/plone.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Plone Community Managed Developer Manual v1.0 documentation" href="../../index.html" />
    <link rel="up" title="Using zope.formlib" href="index.html" />
    <link rel="next" title="Customizing the template and the widgets" href="customtemplate.html" />
    <link rel="prev" title="Creating a simple feedback form" href="simple.html" />
<script language="javascript">
//<![CDATA[

Documentation.addTranslations({"locale": "fr", "plural_expr": "(n > 1)", "messages": {"See the definition": "Voir la d\u00e9finition"}});

// See http://disqus.disqus.com/general_integration_help/
var disqus_developer = 1;
if (document.location.protocol == 'http:') {
    disqus_developer = 0;
}

// Some HTML/CSS transforms we can't do in pure CSS (waiting for CSS3 support)
$(document).ready(function () {

    // Style of .. verisonmodified:: , .. versionadded:: ...
    $('p:has(span.versionmodified)').addClass('p-versionmodified');

    // Style of the TOC tree
    $('ul:has(li.toctree-l1)').addClass('toctree');

    // Decorate links to other sites
    $('a[class~=external]').attr('target', '_blank');

    // Glossary terms
    $('em.xref').attr('title', _('See the definition'));

    // We need to have all <pre> in a <div class="highlight"> to mimic pygments
    // to work around a pygments (?) bug
    var suffixes = {cfg: null, python:null};
    for (var suffix in suffixes) {
        var pattern = 'div.highlight-' + suffix + ' > pre';
        $(pattern).wrap('<div class="highlight" />');
    }
    return true;
});
//]]>
</script>

  </head>
  <body>
<!--[if lte IE 6]>
<style type="text/css">
#ie6msg{border:3px solid #090; margin:8px 0; background:#cfc; color:#000;}
#ie6msg h4{margin:8px; padding:0;}
#ie6msg p{margin:8px; padding:0;}
#ie6msg p a.getie8{font-weight:bold; color:#006;}
#ie6msg p a.ie6expl{font-weight:normal; color:#006;}
</style>
<div id="ie6msg">
<h4>Did you know that your browser is out of date?</h4>
<p>If the layout of this site seems ugly, that's because you're actually using
an outdated browser. And we wont put any effort to provide a nice layout to IE6
users.</p>
<p>To get the best possible experience using our website we recommend that you
upgrade your browser to a newer version. The current version
is <a class="getie8"
href="http://upgradeie.s3.amazonaws.com/eng/index.html">Internet Explorer
8</a>. The upgrade is free. If you're using a PC at work you should contact your
IT administrator.</p>
<p>If you want to you may also try some other popular Internet browsers
like <a class="ie6expl"
href="http://getfirefox.com">Firefox</a>, <a class="ie6expl"
href="http://www.google.com/chrome">Chrome</a>, <a class="ie6expl"
href="http://www.opera.com">Opera</a>, or <a class="ie6expl"
href="http://www.apple.com/safari/download/">Safari</a></p>
</div>
<![endif]-->

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="customtemplate.html" title="Customizing the template and the widgets"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="simple.html" title="Creating a simple feedback form"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Forms, fields and widgets</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Using zope.formlib</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="sphinx-content">
    <div class="section" id="adding-validation">
<h1>Adding validation<a class="headerlink" href="#adding-validation" title="Permalink to this headline">¶</a></h1>
<div class="admonition-description admonition ">
<p class="first admonition-title">Description</p>
<p class="last">Server-side form validation is vital to ensure data sanity and
protect our site from malicious users.</p>
</div>
<div class="section" id="field-validation">
<h2>Field validation<a class="headerlink" href="#field-validation" title="Permalink to this headline">¶</a></h2>
<p>Once you've understood the &quot;hello form&quot;, let's move onto a more
advanced topic: validation.</p>
<p>The easiest way to manage validation in a formlib-based form is to
specify the validation rules in our schema. Actually, you've
already implemented some validation: the customer, subject and
message fields are required. If you leave the <em>subject</em> field
empty, for example, and click the <em>send</em> button, a pretty red error
message will show up asking you to fill that field.</p>
<p>Let's add email validation to the <em>customer</em> field using the
constraint keyword argument fot that attribute in our schema. For
simplicity, the mail address checker that comes with the CMFDefault
utilities toolbox will be used in this example, althought you could
also use your own regular expression checking. The constraint
argument must be a callable that returns <tt class="xref docutils literal"><span class="pre">True</span></tt> if the value
submitted is valid, or raise an exception inheriting from
<tt class="docutils literal"><span class="pre">zope.schema.ValidationError</span></tt>, whose docstring will be used in
the error message.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">zope.schema</span> <span class="kn">import</span> <span class="n">ValidationError</span>

<span class="k">class</span> <span class="nc">InvalidEmailAddress</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">):</span>
    <span class="s">&quot;Invalid email address&quot;</span>

<span class="kn">from</span> <span class="nn">Products.CMFDefault.utils</span> <span class="kn">import</span> <span class="n">checkEmailAddress</span>
<span class="kn">from</span> <span class="nn">Products.CMFDefault.exceptions</span> <span class="kn">import</span> <span class="n">EmailAddressInvalid</span>

<span class="k">def</span> <span class="nf">validateaddress</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">checkEmailAddress</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">EmailAddressInvalid</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidEmailAddress</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">IFeedbackForm</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A typical feedback schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">TextLine</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;Customer&#39;</span><span class="p">,</span>
                      <span class="n">description</span><span class="o">=</span><span class="s">u&#39;Customer email&#39;</span><span class="p">,</span>
                      <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">constraint</span><span class="o">=</span><span class="n">validateaddress</span><span class="p">)</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="n">TextLine</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;Subject&#39;</span><span class="p">,</span>
                       <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">message</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;Message&#39;</span><span class="p">,</span>
                   <span class="n">description</span><span class="o">=</span><span class="s">u&#39;The message body&#39;</span><span class="p">,</span>
                   <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, if you type an invalid address into the <em>customer</em> field and
click <em>send</em>, a kind and colorful error message will be displayed:</p>
<img alt="../../_images/validation_error_pretty.png" src="../../_images/validation_error_pretty.png" />
<p>That was too easy, wasn't it?</p>
</div>
<div class="section" id="invariants-validation">
<h2>Invariants validation<a class="headerlink" href="#invariants-validation" title="Permalink to this headline">¶</a></h2>
<p><em>zope.formlib</em> also supports the validation of schema invariants,
e.g. the min value entered must be smaller than the max value. In
this example the form will be extended to provide a set of
predefined subjects and a field named <em>other</em> which must be filled
when selecting the the <em>Other</em> option in the subject select
dropdown. It's easier to explain it in Python than in English:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">zope.schema</span> <span class="kn">import</span> <span class="n">Choice</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">invariant</span><span class="p">,</span> <span class="n">Invalid</span>

<span class="k">class</span> <span class="nc">IFeedbackForm</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A typical feedback schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">TextLine</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;Customer&#39;</span><span class="p">,</span>
                      <span class="n">description</span><span class="o">=</span><span class="s">u&#39;Customer email&#39;</span><span class="p">,</span>
                      <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                      <span class="n">constraint</span><span class="o">=</span><span class="n">validateaddress</span><span class="p">)</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="n">Choice</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;Subject&#39;</span><span class="p">,</span>
                   <span class="n">vocabulary</span><span class="o">=</span><span class="s">&#39;Available Subjects&#39;</span><span class="p">,</span>
                   <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="p">)</span>

    <span class="n">other</span> <span class="o">=</span> <span class="n">TextLine</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;Other&#39;</span><span class="p">,</span>
                     <span class="n">description</span><span class="o">=</span><span class="s">u&quot;&quot;&quot;</span>
<span class="s">                        If you&#39;ve specified Other above,</span>
<span class="s">                        please fill this this field too.&quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">message</span> <span class="o">=</span> <span class="n">Text</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">u&#39;Message&#39;</span><span class="p">,</span>
                   <span class="n">description</span><span class="o">=</span><span class="s">u&#39;The message body&#39;</span><span class="p">,</span>
                   <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="nd">@invariant</span>
    <span class="k">def</span> <span class="nf">otherFilledIfSelected</span><span class="p">(</span><span class="n">feedback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">subject</span> <span class="o">==</span> <span class="s">u&#39;Other&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">feedback</span><span class="o">.</span><span class="n">other</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Invalid</span><span class="p">(</span><span class="s">&quot;Please specify the motivation of your request&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, the <em>subject</em> field type has been set to <em>Choice</em>, and the
list of available values has been indicated to be obtained from the
<em>Available Subjects</em> vocabulary, a named utility which will be
defined shortly.</p>
<p>The form will call all the <em>invariant</em>-decorated functions of the
schema upon validation and catch any raised <em>Invalid</em> exceptions.</p>
<p>You still need to define the <em>Available Subjects</em> vocabulary:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">zope.schema.vocabulary</span> <span class="kn">import</span> <span class="n">SimpleVocabulary</span>

<span class="k">def</span> <span class="nf">availableSubjects</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">subjects</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Comment&#39;</span><span class="p">,</span>
                <span class="s">&#39;Feature Request&#39;</span><span class="p">,</span>
                <span class="s">&#39;Technical Issue&#39;</span><span class="p">,</span>
                <span class="s">&#39;Complaint&#39;</span><span class="p">,</span>
                <span class="s">&#39;Other&#39;</span><span class="p">,</span>
                <span class="p">)</span>
    <span class="k">return</span> <span class="n">SimpleVocabulary</span><span class="o">.</span><span class="n">fromValues</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>
</pre></div>
</div>
<p>and register it as a named utility using ZCML in the
<tt class="docutils literal"><span class="pre">configure.zcml</span></tt> file:</p>
<div class="highlight-python"><pre>&lt;configure ... &gt;
...
    &lt;utility
            component=".browser.availableSubjects"
            name="Available Subjects"
            provides="zope.schema.interfaces.IVocabularyFactory"
            /&gt;
&lt;/configure&gt;</pre>
</div>
<p>Restart your Zope instance for the changes to take effect and test
your new form. You'll see something similar to this:</p>
<img alt="../../_images/invariant_error.png" src="../../_images/invariant_error.png" />
<p>Unfortunately, invariant errors descriptions are not shown in the
default template.</p>
</div>
</div>

  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<p class="logo"><a href="../../index.html"><img src="../../_static/plone-icon-64.png" />
</a></p>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Adding validation</a><ul>
<li><a class="reference internal" href="#field-validation">Field validation</a></li>
<li><a class="reference internal" href="#invariants-validation">Invariants validation</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="simple.html"
                        title="previous chapter">Creating a simple feedback form</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="customtemplate.html"
                        title="next chapter">Customizing the template and the widgets</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/forms/formlib/validation.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="customtemplate.html" title="Customizing the template and the widgets"
             >next</a> |</li>
        <li class="right" >
          <a href="simple.html" title="Creating a simple feedback form"
             >previous</a> |</li>
        <li><a href="../../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Forms, fields and widgets</a> &raquo;</li>
          <li><a href="index.html" >Using zope.formlib</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2010 mFabrik Research Oy and Plone community contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>


  </body>
</html>