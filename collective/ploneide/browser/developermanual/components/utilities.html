<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Utilities &mdash; Plone Community Managed Developer Manual v1.0 documentation</title>
    <link rel="stylesheet" href="../_static/plone.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Plone Community Managed Developer Manual v1.0 documentation" href="../index.html" />
    <link rel="up" title="Component architecture" href="index.html" />
    <link rel="next" title="Grok framework" href="grok.html" />
    <link rel="prev" title="Adapters" href="adapters.html" />
<script language="javascript">
//<![CDATA[

Documentation.addTranslations({"locale": "fr", "plural_expr": "(n > 1)", "messages": {"See the definition": "Voir la d\u00e9finition"}});

// See http://disqus.disqus.com/general_integration_help/
var disqus_developer = 1;
if (document.location.protocol == 'http:') {
    disqus_developer = 0;
}

// Some HTML/CSS transforms we can't do in pure CSS (waiting for CSS3 support)
$(document).ready(function () {

    // Style of .. verisonmodified:: , .. versionadded:: ...
    $('p:has(span.versionmodified)').addClass('p-versionmodified');

    // Style of the TOC tree
    $('ul:has(li.toctree-l1)').addClass('toctree');

    // Decorate links to other sites
    $('a[class~=external]').attr('target', '_blank');

    // Glossary terms
    $('em.xref').attr('title', _('See the definition'));

    // We need to have all <pre> in a <div class="highlight"> to mimic pygments
    // to work around a pygments (?) bug
    var suffixes = {cfg: null, python:null};
    for (var suffix in suffixes) {
        var pattern = 'div.highlight-' + suffix + ' > pre';
        $(pattern).wrap('<div class="highlight" />');
    }
    return true;
});
//]]>
</script>

  </head>
  <body>
<!--[if lte IE 6]>
<style type="text/css">
#ie6msg{border:3px solid #090; margin:8px 0; background:#cfc; color:#000;}
#ie6msg h4{margin:8px; padding:0;}
#ie6msg p{margin:8px; padding:0;}
#ie6msg p a.getie8{font-weight:bold; color:#006;}
#ie6msg p a.ie6expl{font-weight:normal; color:#006;}
</style>
<div id="ie6msg">
<h4>Did you know that your browser is out of date?</h4>
<p>If the layout of this site seems ugly, that's because you're actually using
an outdated browser. And we wont put any effort to provide a nice layout to IE6
users.</p>
<p>To get the best possible experience using our website we recommend that you
upgrade your browser to a newer version. The current version
is <a class="getie8"
href="http://upgradeie.s3.amazonaws.com/eng/index.html">Internet Explorer
8</a>. The upgrade is free. If you're using a PC at work you should contact your
IT administrator.</p>
<p>If you want to you may also try some other popular Internet browsers
like <a class="ie6expl"
href="http://getfirefox.com">Firefox</a>, <a class="ie6expl"
href="http://www.google.com/chrome">Chrome</a>, <a class="ie6expl"
href="http://www.opera.com">Opera</a>, or <a class="ie6expl"
href="http://www.apple.com/safari/download/">Safari</a></p>
</div>
<![endif]-->

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="grok.html" title="Grok framework"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="adapters.html" title="Adapters"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Component architecture</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="sphinx-content">
    <div class="section" id="utilities">
<h1>Utilities<a class="headerlink" href="#utilities" title="Permalink to this headline">¶</a></h1>
<div class="admonition-description admonition ">
<p class="first admonition-title">Description</p>
<p class="last">Utility design pattern in Zope 3 allows easily overridable singleton class instances
for your code.</p>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a><ul>
<li><a class="reference internal" href="#local-and-global-utilities" id="id2">Local and global utilities</a></li>
</ul>
</li>
<li><a class="reference internal" href="#registering-a-global-utility" id="id3">Registering a global utility</a></li>
<li><a class="reference internal" href="#registering-a-local-utility" id="id4">Registering a local utility</a></li>
<li><a class="reference internal" href="#overriding-utility" id="id5">Overriding utility</a></li>
<li><a class="reference internal" href="#getting-utility" id="id6">Getting utility</a></li>
<li><a class="reference internal" href="#getting-all-named-utilities-of-one-interface" id="id7">Getting all named utilities of one interface</a></li>
<li><a class="reference internal" href="#unregistering-utilities" id="id8">Unregistering utilities</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Utility classes provide site-wide utility functions.</li>
<li>They are registered by marker interfaces.</li>
<li>Site customization logic or add-on products can override utility for enhanced or modified functionality</li>
<li>Utilities can be looked up by name or interface</li>
<li>Compared to &quot;plain Python functions&quot; utiltiies provide the advantage of being plug-in points without need of <a class="reference internal" href="../misc/monkeypatch.html"><em>monkey-patching</em></a></li>
</ul>
<p>Read more in</p>
<ul class="simple">
<li><a class="reference external" href="http://plone.org/products/dexterity/documentation/manual/five.grok/core-components/utilities">http://plone.org/products/dexterity/documentation/manual/five.grok/core-components/utilities</a></li>
<li><a class="reference external" href="http://apidoc.zope.org/++apidoc++/Code/zope/component/README.txt/index.html">zope.component documentation</a>.</li>
</ul>
<div class="section" id="local-and-global-utilities">
<h3><a class="toc-backref" href="#id2">Local and global utilities</a><a class="headerlink" href="#local-and-global-utilities" title="Permalink to this headline">¶</a></h3>
<p>Utilities can be</p>
<ul class="simple">
<li>global - registered during Zope start-up</li>
<li>local - registered during add-on installer for a certain site/content item</li>
</ul>
<p>Local utilities are registered to persistent object.
The context of local utilities is stored in a thread local variable which is set
during the traversing. Thus, when you ask for local utilities, they usually
come from persistent registry set up in the Plone site root object.</p>
<p>Global utilities are registered in ZCML and affect all Zope application server and Plone site instances.</p>
<p>Some hints:</p>
<div class="highlight-python"><pre>&lt;Moo^_^&gt; what's difference between gsm.queryUtility() (global site manager) and zope.component.queryUtility()
&lt;agroszer&gt; Moo^_^, I think gsm... takes the global registrations, z.c.queryUtility respects the current context</pre>
</div>
</div>
</div>
<div class="section" id="registering-a-global-utility">
<h2><a class="toc-backref" href="#id3">Registering a global utility</a><a class="headerlink" href="#registering-a-global-utility" title="Permalink to this headline">¶</a></h2>
<p>Utility is constructed when Plone is started and ZCML is read.
Utilities take no constructor parameters. If you need to use parameters
like context or request, consider using views or adapters instead.
Utilities may or may not have a name.</p>
<ul class="simple">
<li>Utility can be provided by a function: function is being called and it returns utility object</li>
<li>Utility can be provided by a class: class __call__() method itself acts as an factory and returns new class instance</li>
</ul>
<p>ZCML example:</p>
<div class="highlight-python"><pre>&lt;!-- Register header animation picking logic - override this for your custom logic --&gt;
&lt;utility
  provides="gomobile.convergence.interfaces.IConvergenceMediaFilter"
  factory=".filter.ConvergedMediaFilter" /&gt;</pre>
</div>
<p>Python example (named utility):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">registerOnsitePaymentProcessor</span><span class="p">(</span><span class="n">processor_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>

    <span class="c"># Make OnsitePaymentProcessor class available as utiltiy</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">processor_class</span><span class="p">()</span>
    <span class="n">gsm</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">getGlobalSiteManager</span><span class="p">()</span>
    <span class="n">gsm</span><span class="o">.</span><span class="n">registerUtility</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">IOnsitePaymentProcessor</span><span class="p">,</span> <span class="n">processor</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>The utility class &quot;factory&quot; is in its simplest form a class which implements the interface:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ConvergedMediaFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper class to deal with media state of content objects.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">zope</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">implements</span><span class="p">(</span><span class="n">IConvergenceMediaFilter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">foobar</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; An example method &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">2</span>
</pre></div>
</div>
<p>Class is constructed / factory is run during the ZCML initialization.</p>
<p>To use this class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">gomobile.convergence.interfaces</span> <span class="kn">import</span> <span class="n">IConvergenceMediaFilter</span>

<span class="k">def</span> <span class="nf">something</span><span class="p">():</span>
   <span class="nb">filter</span> <span class="o">=</span> <span class="n">getUtility</span><span class="p">(</span><span class="n">IConvergenceMediaFilter</span><span class="p">)</span>
   <span class="n">x</span> <span class="o">=</span> <span class="nb">filter</span><span class="o">.</span><span class="n">foobar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="registering-a-local-utility">
<h2><a class="toc-backref" href="#id4">Registering a local utility</a><a class="headerlink" href="#registering-a-local-utility" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://plone.org/documentation/manual/developer-manual/generic-setup/reference/component-registry">http://plone.org/documentation/manual/developer-manual/generic-setup/reference/component-registry</a></li>
<li><a class="reference external" href="http://davisagli.com/blog/registering-add-on-specific-components-using-z3c.baseregistry">http://davisagli.com/blog/registering-add-on-specific-components-using-z3c.baseregistry</a></li>
<li><a class="reference external" href="http://pypi.python.org/pypi/z3c.baseregistry">http://pypi.python.org/pypi/z3c.baseregistry</a></li>
</ul>
</div>
<div class="section" id="overriding-utility">
<h2><a class="toc-backref" href="#id5">Overriding utility</a><a class="headerlink" href="#overriding-utility" title="Permalink to this headline">¶</a></h2>
<p>If you want to override any existing utility you can re-register the utility  in <tt class="docutils literal"><span class="pre">overrides.zcml</span></tt> file in your product.</p>
</div>
<div class="section" id="getting-utility">
<h2><a class="toc-backref" href="#id6">Getting utility</a><a class="headerlink" href="#getting-utility" title="Permalink to this headline">¶</a></h2>
<p>There are two functions</p>
<blockquote>
<ul class="simple">
<li>zope.component.getUtility will raise exception if utility is not found</li>
<li>zope.component.queryUtility will return None if utility is not found</li>
</ul>
</blockquote>
<p>Utility query parameters are passed to the utility class constructor.</p>
<p>Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">zope.component</span> <span class="kn">import</span> <span class="n">getUtility</span><span class="p">,</span> <span class="n">queryUtility</span>

<span class="c"># context and request are passed to the utility class constructor</span>
<span class="c"># they are optional and depend on the utility itself</span>
<span class="n">picker</span> <span class="o">=</span> <span class="n">getUtility</span><span class="p">(</span><span class="n">IHeaderAnimationPicker</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You cannot use getUtility() on Python module body level code
during import, as Zope Component Architecture is not yet initialized.
Always call getUtility() from HTTP request end point or after Zope
has been started.</p>
</div>
<p>Query local + global utilities:</p>
<div class="highlight-python"><pre>``zope.component.queryUtility()`` for local utilities, with global fallback.</pre>
</div>
<p>Query only global utilities:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">zope.app</span> <span class="kn">import</span> <span class="n">zapi</span>
<span class="n">gsm</span> <span class="o">=</span> <span class="n">zapi</span><span class="o">.</span><span class="n">getGlobalSiteManager</span><span class="p">()</span>
<span class="k">return</span> <span class="n">gsm</span><span class="o">.</span><span class="n">getUtility</span><span class="p">(</span><span class="n">IConvergenceMediaFilter</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Due to Zope component architecture initialization order, you cannot call getUtility()
in module level Python code. Module level Python code is run when the module is being
imported, and Zope components are not yet necessary set up in this point.</p>
</div>
</div>
<div class="section" id="getting-all-named-utilities-of-one-interface">
<h2><a class="toc-backref" href="#id7">Getting all named utilities of one interface</a><a class="headerlink" href="#getting-all-named-utilities-of-one-interface" title="Permalink to this headline">¶</a></h2>
<p>Use zope.component.getUtilitiesFor().</p>
<p>Example</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">OnsitePaymentProcessors</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; List all registered on-site payment processors.</span>

<span class="sd">    Mostly useful for validating form input.</span>

<span class="sd">    Vocabulary contains all payment processors, not just active ones.</span>

<span class="sd">    @return: zope.vocabulary.SimpleVocabulary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">utilities</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">getUtilitiesFor</span><span class="p">(</span><span class="n">interfaces</span><span class="o">.</span><span class="n">IOnsitePaymentProcessor</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">utilities</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="unregistering-utilities">
<h2><a class="toc-backref" href="#id8">Unregistering utilities</a><a class="headerlink" href="#unregistering-utilities" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.muthukadan.net/docs/zca.html#unregisterutility">http://www.muthukadan.net/docs/zca.html#unregisterutility</a></li>
</ul>
</div>
</div>

  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<p class="logo"><a href="../index.html"><img src="../_static/plone-icon-64.png" />
</a></p>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Utilities</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a><ul>
<li><a class="reference internal" href="#local-and-global-utilities">Local and global utilities</a></li>
</ul>
</li>
<li><a class="reference internal" href="#registering-a-global-utility">Registering a global utility</a></li>
<li><a class="reference internal" href="#registering-a-local-utility">Registering a local utility</a></li>
<li><a class="reference internal" href="#overriding-utility">Overriding utility</a></li>
<li><a class="reference internal" href="#getting-utility">Getting utility</a></li>
<li><a class="reference internal" href="#getting-all-named-utilities-of-one-interface">Getting all named utilities of one interface</a></li>
<li><a class="reference internal" href="#unregistering-utilities">Unregistering utilities</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="adapters.html"
                        title="previous chapter">Adapters</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="grok.html"
                        title="next chapter">Grok framework</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/components/utilities.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="grok.html" title="Grok framework"
             >next</a> |</li>
        <li class="right" >
          <a href="adapters.html" title="Adapters"
             >previous</a> |</li>
        <li><a href="../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Component architecture</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2010 mFabrik Research Oy and Plone community contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>


  </body>
</html>