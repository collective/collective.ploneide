<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Nginx &mdash; Plone Community Managed Developer Manual v1.0 documentation</title>
    <link rel="stylesheet" href="../_static/plone.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Plone Community Managed Developer Manual v1.0 documentation" href="../index.html" />
    <link rel="up" title="Hosting" href="index.html" />
    <link rel="next" title="Deliverance" href="deliverance.html" />
    <link rel="prev" title="Varnish" href="varnish.html" />
<script language="javascript">
//<![CDATA[

Documentation.addTranslations({"locale": "fr", "plural_expr": "(n > 1)", "messages": {"See the definition": "Voir la d\u00e9finition"}});

// See http://disqus.disqus.com/general_integration_help/
var disqus_developer = 1;
if (document.location.protocol == 'http:') {
    disqus_developer = 0;
}

// Some HTML/CSS transforms we can't do in pure CSS (waiting for CSS3 support)
$(document).ready(function () {

    // Style of .. verisonmodified:: , .. versionadded:: ...
    $('p:has(span.versionmodified)').addClass('p-versionmodified');

    // Style of the TOC tree
    $('ul:has(li.toctree-l1)').addClass('toctree');

    // Decorate links to other sites
    $('a[class~=external]').attr('target', '_blank');

    // Glossary terms
    $('em.xref').attr('title', _('See the definition'));

    // We need to have all <pre> in a <div class="highlight"> to mimic pygments
    // to work around a pygments (?) bug
    var suffixes = {cfg: null, python:null};
    for (var suffix in suffixes) {
        var pattern = 'div.highlight-' + suffix + ' > pre';
        $(pattern).wrap('<div class="highlight" />');
    }
    return true;
});
//]]>
</script>

  </head>
  <body>
<!--[if lte IE 6]>
<style type="text/css">
#ie6msg{border:3px solid #090; margin:8px 0; background:#cfc; color:#000;}
#ie6msg h4{margin:8px; padding:0;}
#ie6msg p{margin:8px; padding:0;}
#ie6msg p a.getie8{font-weight:bold; color:#006;}
#ie6msg p a.ie6expl{font-weight:normal; color:#006;}
</style>
<div id="ie6msg">
<h4>Did you know that your browser is out of date?</h4>
<p>If the layout of this site seems ugly, that's because you're actually using
an outdated browser. And we wont put any effort to provide a nice layout to IE6
users.</p>
<p>To get the best possible experience using our website we recommend that you
upgrade your browser to a newer version. The current version
is <a class="getie8"
href="http://upgradeie.s3.amazonaws.com/eng/index.html">Internet Explorer
8</a>. The upgrade is free. If you're using a PC at work you should contact your
IT administrator.</p>
<p>If you want to you may also try some other popular Internet browsers
like <a class="ie6expl"
href="http://getfirefox.com">Firefox</a>, <a class="ie6expl"
href="http://www.google.com/chrome">Chrome</a>, <a class="ie6expl"
href="http://www.opera.com">Opera</a>, or <a class="ie6expl"
href="http://www.apple.com/safari/download/">Safari</a></p>
</div>
<![endif]-->

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="deliverance.html" title="Deliverance"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="varnish.html" title="Varnish"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Hosting</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="sphinx-content">
    <div class="section" id="nginx">
<h1>Nginx<a class="headerlink" href="#nginx" title="Permalink to this headline">¶</a></h1>
<div class="admonition-description admonition ">
<p class="first admonition-title">Description</p>
<p class="last">Using Nginx web server to host Plone sites</p>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#buildout-and-recipe" id="id2">Buildout and recipe</a></li>
<li><a class="reference internal" href="#config-test" id="id3">Config test</a></li>
<li><a class="reference internal" href="#deployment-configuration" id="id4">Deployment configuration</a></li>
<li><a class="reference internal" href="#killing-loose-nginx" id="id5">Killing loose Nginx</a></li>
<li><a class="reference internal" href="#debugging-nginx" id="id6">Debugging Nginx</a></li>
<li><a class="reference internal" href="#www-redirect" id="id7">www-redirect</a></li>
<li><a class="reference internal" href="#permanent-redirect" id="id8">Permanent redirect</a><ul>
<li><a class="reference internal" href="#cleaning-up-query-string" id="id9">Cleaning up query string</a></li>
<li><a class="reference internal" href="#matching-incoming-query-string" id="id10">Matching incoming query string</a></li>
<li><a class="reference internal" href="#more-info" id="id11">More info</a></li>
</ul>
</li>
<li><a class="reference internal" href="#make-nginx-aware-where-the-request-came-from" id="id12">Make NGINX aware where the request came from</a></li>
<li><a class="reference internal" href="#php-with-nginx-and-php-fpm" id="id13">PHP with NGINX and PHP-FPM</a></li>
<li><a class="reference internal" href="#ssi-server-side-include" id="id14">SSI - server side include</a></li>
<li><a class="reference internal" href="#session-affinity" id="id15">Session affinity</a><ul>
<li><a class="reference internal" href="#by-using-ip-addresses" id="id16">By using IP addresses</a></li>
<li><a class="reference internal" href="#by-using-cookies" id="id17">By using cookies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#securing-plone-sites-with-https-and-nginx" id="id18">Securing Plone-Sites with https and nginx</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Nginx is an modern alternative server to Apache</p>
<ul class="simple">
<li>Acts as a proxy server and load balancer at the front of Zope</li>
<li>Handle rewrite rules</li>
<li>Handle HTTPS</li>
</ul>
</div>
<div class="section" id="buildout-and-recipe">
<h2><a class="toc-backref" href="#id2">Buildout and recipe</a><a class="headerlink" href="#buildout-and-recipe" title="Permalink to this headline">¶</a></h2>
<p>Use the recipe and buildout example below to get started</p>
<ul class="simple">
<li><a class="reference external" href="http://www.martinaspeli.net/articles/an-uber-buildout-for-a-production-plone-server">http://www.martinaspeli.net/articles/an-uber-buildout-for-a-production-plone-server</a></li>
<li><a class="reference external" href="http://pypi.python.org/pypi/gocept.nginx">http://pypi.python.org/pypi/gocept.nginx</a></li>
</ul>
<p>A buildout will download, install and configure Nginx from a scratch.
Buildout file contains included Nginx configuration which can use
template variables from buildout.cfg itself.</p>
<p>When you change the configuration if Nginx in buildout you probably don't
want to rerun the whole buildout, but only Nginx part of it:</p>
<div class="highlight-python"><pre>bin/buildout -c production.cfg install balancer</pre>
</div>
</div>
<div class="section" id="config-test">
<h2><a class="toc-backref" href="#id3">Config test</a><a class="headerlink" href="#config-test" title="Permalink to this headline">¶</a></h2>
<p>Assuming you have a buildout nginx section called <tt class="docutils literal"><span class="pre">balancer</span></tt>:</p>
<div class="highlight-python"><pre>bin/balancer configtest

Testing nginx configuration
the configuration file /srv/plone/isleofback/parts/balancer/balancer.conf syntax is ok
configuration file /srv/plone/isleofback/parts/balancer/balancer.conf test is successful</pre>
</div>
</div>
<div class="section" id="deployment-configuration">
<h2><a class="toc-backref" href="#id4">Deployment configuration</a><a class="headerlink" href="#deployment-configuration" title="Permalink to this headline">¶</a></h2>
<p><em>gocept.nginx</em> supports special deployment configuration where you
manually configure all directories. The most important thing, why one
wish to do this, is take pid file out of parts/ so that you can
reliably start and stop Nginx even if you re-run buildout:
buildout nukes parts/, pid file gets lost and you need
to manually kill Nginx.</p>
<p>Example deployment configure in production.cfg:</p>
<div class="highlight-python"><pre># Define folder and file locations for Nginx called "balancer"
# If deployment= is set on gocept.nginx recipe it uses
# data provider here
[nginx]
run-directory = ${buildout:directory}/var/nginx
etc-directory = ${buildout:directory}/var/nginx
log-directory = ${buildout:directory}/var/logs
rc-directory = ${buildout:directory}/bin
logrotate-directory =
user =

[balancer]
recipe = gocept.nginx
nginx = nginx-build
deployment = nginx
configuration =
        #user ${users:balancer};
        error_log ${buildout:directory}/var/log/balancer-error.log;
        worker_processes 1;</pre>
</div>
<p>Install this part:</p>
<div class="highlight-python"><pre>bin/buildout -c production.cfg install balancer</pre>
</div>
<p>Then you can use the following cycle to update the configuration:</p>
<div class="highlight-python"><pre>bin/balancer-nginx-balancer start
# Update config in buildout
nano production.cfg
# This is non-destructive, because now our PID file is in var/nginx
bin/buildout -c production.cfg install balancer
# Looks like reload is not enough
bin/nginx-balancer stop ; bin/nginx-balancer start</pre>
</div>
</div>
<div class="section" id="killing-loose-nginx">
<h2><a class="toc-backref" href="#id5">Killing loose Nginx</a><a class="headerlink" href="#killing-loose-nginx" title="Permalink to this headline">¶</a></h2>
<p>You have lost PID file or the actual Nginx PID does not match the real PID any longer.
Use buildout's starter script as a search key:</p>
<div class="highlight-python"><pre>(hardy_i386)isleofback@isleofback:~$ bin/balancer reload
Reloading nginx
cat: /srv/plone/isleofback/parts/balancer/balancer.pid: No such file or directory

(hardy_i386)isleofback@isleofback:~$ ps -Af|grep -i balancer
1001     14012     1  0 15:26 ?        00:00:00 nginx: master process /srv/plone/isleofback/parts/nginx-build/sbin/nginx -c /srv/plone/isleofback/parts/balancer/balancer.conf
1001     16488 16458  0 16:34 pts/2    00:00:00 grep -i balancer
(hardy_i386)isleofback@isleofback:~$ kill 14012

# balancer is no longer running
(hardy_i386)isleofback@isleofback:~$ ps -Af|grep -i balancer
1001     16496 16458  0 16:34 pts/2    00:00:00 grep -i balancer

(hardy_i386)isleofback@isleofback:~$ bin/balancer start
Starting nginx

# Now it is running again
(hardy_i386)isleofback@isleofback:~$ ps -Af|grep -i balancer
1001     16501     1  0 16:34 ?        00:00:00 nginx: master process /srv/plone/isleofback/parts/nginx-build/sbin/nginx -c /srv/plone/isleofback/parts/balancer/balancer.conf
1001     16504 16458  0 16:34 pts/2    00:00:00 grep -i balancer</pre>
</div>
</div>
<div class="section" id="debugging-nginx">
<h2><a class="toc-backref" href="#id6">Debugging Nginx</a><a class="headerlink" href="#debugging-nginx" title="Permalink to this headline">¶</a></h2>
<p>Set Nginx logging to debug mode:</p>
<div class="highlight-python"><pre>error_log ${buildout:directory}/var/log/balancer-error.log debug;</pre>
</div>
</div>
<div class="section" id="www-redirect">
<h2><a class="toc-backref" href="#id7">www-redirect</a><a class="headerlink" href="#www-redirect" title="Permalink to this headline">¶</a></h2>
<p>Below is an example how to do a basic yourdomain.com -&gt; www.yourdomain.com redirect.</p>
<p>Put the following to your <em>gocept.nginx</em> configuration:</p>
<div class="highlight-python"><pre>http {
        ....
        server {
                listen ${hosts:balancer}:${ports:balancer};
                server_name ${hosts:main-alias};
                access_log off;
                rewrite ^(.*)$  $scheme://${hosts:main}$1 redirect;
        }</pre>
</div>
<p>Hosts are configured in a separate buildout section:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">hosts</span><span class="p">]</span>
<span class="c"># Hostnames for servers</span>
<span class="n">main</span> <span class="o">=</span> <span class="n">www</span><span class="o">.</span><span class="n">yoursite</span><span class="o">.</span><span class="n">com</span>
<span class="n">main</span><span class="o">-</span><span class="n">alias</span> <span class="o">=</span> <span class="n">yoursite</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>More info</p>
<ul class="simple">
<li><a class="reference external" href="http://aleksandarsavic.com/nginx-redirect-wwwexamplecom-requests-to-examplecom-or-vice-versa/">http://aleksandarsavic.com/nginx-redirect-wwwexamplecom-requests-to-examplecom-or-vice-versa/</a></li>
</ul>
</div>
<div class="section" id="permanent-redirect">
<h2><a class="toc-backref" href="#id8">Permanent redirect</a><a class="headerlink" href="#permanent-redirect" title="Permalink to this headline">¶</a></h2>
<p>Below is an example redirect rule:</p>
<div class="highlight-python"><pre># Redirect old Google front page links.
# Redirect event to new Plone based systems.

location /tapahtumat.php {
        rewrite ^ http://${hosts:main}/tapahtumat permanent;
}</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Nginx location match evaluation rules are not always top-down.
You can add more specific matches after location /.</p>
</div>
<div class="section" id="cleaning-up-query-string">
<h3><a class="toc-backref" href="#id9">Cleaning up query string</a><a class="headerlink" href="#cleaning-up-query-string" title="Permalink to this headline">¶</a></h3>
<p>By default, Nginx includes all trailing HTTP GET query parameters in the redirect.
You can disable this behavior by adding a trailing ?:</p>
<div class="highlight-python"><pre>location /tapahtumat.php {
        rewrite ^ http://${hosts:main}/no_ugly_query_string? permanent;
}</pre>
</div>
</div>
<div class="section" id="matching-incoming-query-string">
<h3><a class="toc-backref" href="#id10">Matching incoming query string</a><a class="headerlink" href="#matching-incoming-query-string" title="Permalink to this headline">¶</a></h3>
<p>Location directive does not support query strings.
Use <em>if</em> directive from HTTP rewrite module.</p>
<p>Example:</p>
<div class="highlight-python"><pre>location /index.php {
        # index.php?id=5
        if ($args ~ id=5) {
                rewrite ^ http://${hosts:main}/sisalto/lomapalvelut/ruokailu? permanent;
        }
}</pre>
</div>
</div>
<div class="section" id="more-info">
<h3><a class="toc-backref" href="#id11">More info</a><a class="headerlink" href="#more-info" title="Permalink to this headline">¶</a></h3>
<p>Nginx location matching rules</p>
<ul class="simple">
<li><a class="reference external" href="http://wiki.nginx.org/NginxHttpCoreModule#location">http://wiki.nginx.org/NginxHttpCoreModule#location</a></li>
</ul>
<p>Nginx redirect module docs</p>
<ul class="simple">
<li><a class="reference external" href="http://wiki.nginx.org/NginxHttpRewriteModule">http://wiki.nginx.org/NginxHttpRewriteModule</a></li>
</ul>
<p>More info of Nginx redirects</p>
<ul class="simple">
<li><a class="reference external" href="http://scott.yang.id.au/2007/04/do-you-need-permalink-redirect/">http://scott.yang.id.au/2007/04/do-you-need-permalink-redirect/</a></li>
<li><a class="reference external" href="http://aleksandarsavic.com/nginx-and-wordpress-setup-clean-seo-friendly-urls/">http://aleksandarsavic.com/nginx-and-wordpress-setup-clean-seo-friendly-urls/</a></li>
</ul>
</div>
</div>
<div class="section" id="make-nginx-aware-where-the-request-came-from">
<h2><a class="toc-backref" href="#id12">Make NGINX aware where the request came from</a><a class="headerlink" href="#make-nginx-aware-where-the-request-came-from" title="Permalink to this headline">¶</a></h2>
<p>If you set up NGINX to run in front of Zope, and set up a virtual host with it like this:</p>
<div class="highlight-python"><pre>server {
        server_name demo.webandmobile.mfabrik.com;
        location / {
                rewrite ^/(.*)$ /VirtualHostBase/http/demo.webandmobile.mfabrik.com:80/Plone/VirtualHostRoot/$1 break;
                proxy_pass http://127.0.0.1:8080/;
        }
}</pre>
</div>
<p>Zope will always get the request from 127.0.0.1:8080 and not from the actual host, due to the redirection. To solve this problem correct your configuration to be like this:</p>
<div class="highlight-python"><pre>server {
        server_name demo.webandmobile.mfabrik.com;
        location / {
                rewrite ^/(.*)$ /VirtualHostBase/http/demo.webandmobile.mfabrik.com:80/Plone/VirtualHostRoot/$1 break;
                proxy_pass http://127.0.0.1:8080/;
                proxy_set_header        Host            $host;
                proxy_set_header        X-Real-IP       $remote_addr;
                proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        }
}</pre>
</div>
</div>
<div class="section" id="php-with-nginx-and-php-fpm">
<h2><a class="toc-backref" href="#id13">PHP with NGINX and PHP-FPM</a><a class="headerlink" href="#php-with-nginx-and-php-fpm" title="Permalink to this headline">¶</a></h2>
<p>If you are coming from Apache world, you may be used to the
scenario where Apache handles all php related stuff. Well on
NGINX its a bit different: it does not automatically spawn
FCGI processes, so you must start them separately. In fact,
FCGI is a lot like proxying, which means that PHP-FPM will
run as a separate server and all we need to do is to forward
the request to it.</p>
<p>A detailed tutorial on how to set it all up, configure and run
it can be found here:</p>
<ul class="simple">
<li><a class="reference external" href="http://alasdoo.com/2010/12/xdv-plone-and-phpbb-under-one-nginx-roof/">http://alasdoo.com/2010/12/xdv-plone-and-phpbb-under-one-nginx-roof/</a></li>
</ul>
</div>
<div class="section" id="ssi-server-side-include">
<h2><a class="toc-backref" href="#id14">SSI - server side include</a><a class="headerlink" href="#ssi-server-side-include" title="Permalink to this headline">¶</a></h2>
<p>In order to include external content to a page (XDV), we must
set up NGINX to make these includes for us. For including
external content we will use SSI (server side include)
method, which means that on each request NGINX will get the
needed external content, put it in place and only then return
the response. Here is a configuration that sets up the filtering
and turns on ssi for a specific location:</p>
<div class="highlight-python"><pre>server {
        listen 80;
        server_name localhost;

        # Decide if we need to filter
        if ($args ~ "^(.*);filter_xpath=(.*)$") {
            set $newargs $1;
            set $filter_xpath $2;
            # rewrite args to avoid looping
            rewrite    ^(.*)$    /_include$1?$newargs?;
        }

        location @include500 { return 500; }
        location @include404 { return 404; }

        location ^~ /_include {
            # Restrict to subrequests
            internal;
            error_page 404 = @include404;

            # Cache in Varnish for 1h
            expires 1h;

            # Proxy
            rewrite    ^/_include(.*)$    $1    break;
            proxy_pass http://127.0.0.1:80;

            # Our safety belt.
            proxy_set_header X-Loop 1$http_X_Loop; # unary count
            proxy_set_header Accept-Encoding "";
            error_page 500 = @include500;
            if ($http_X_Loop ~ "11111") {
                return 500;
            }

            # Filter by xpath
            xslt_stylesheet /home/ubuntu/plone/eggs/xdv-0.4b2-py2.6.egg/xdv/filter.xsl
            xpath=$filter_xpath
            ;
            xslt_html_parser on;
            xslt_types text/html;
        }


        location /forum {
            xslt_stylesheet /home/ubuntu/plone/theme/theme.xsl
            path='$uri'
            ;
            xslt_html_parser on;
            xslt_types text/html;
            # Switch on ssi here to enable external includes.
            ssi on;

            root   /home/ubuntu/phpBB3;
            index  index.php;
            try_files $uri $uri/ /index.php?q=$uri&amp;$args;
        }
}</pre>
</div>
</div>
<div class="section" id="session-affinity">
<h2><a class="toc-backref" href="#id15">Session affinity</a><a class="headerlink" href="#session-affinity" title="Permalink to this headline">¶</a></h2>
<p>If you indent to use nginx for session balancing between ZEO processes,
you need to be aware of session affinity.
By default, ZEO processes don't share session data. If you have site functionality
which stores user specific data on the server, let's say an ecommerce site shopping cart,
you must always redirect users to the same ZEO process or they will have 1/number of processes
chance to see the orignal data.</p>
<p>Make sure that your <a class="reference internal" href="../sessions/cookies.html"><em>Zope session cookie</em></a> is not cleared by any front-end
server (Nginx, Varnish).</p>
<div class="section" id="by-using-ip-addresses">
<h3><a class="toc-backref" href="#id16">By using IP addresses</a><a class="headerlink" href="#by-using-ip-addresses" title="Permalink to this headline">¶</a></h3>
<p>This is the most reliable way. Nginx will balance each incoming request
to a front end client by the request's source IP address.</p>
<p>This method is reliable as long as Nginx can extract correctly
IP address from the configuration.</p>
<ul class="simple">
<li><a class="reference external" href="http://wiki.nginx.org/NginxHttpUpstreamModule#ip_hash">http://wiki.nginx.org/NginxHttpUpstreamModule#ip_hash</a></li>
</ul>
</div>
<div class="section" id="by-using-cookies">
<h3><a class="toc-backref" href="#id17">By using cookies</a><a class="headerlink" href="#by-using-cookies" title="Permalink to this headline">¶</a></h3>
<p>These instructions assume you are installing nginx via buildout.</p>
<ul class="simple">
<li><a class="reference external" href="http://nginx-sticky-module.googlecode.com/files/nginx-sticky-module-1.0-rc2.tar.gz">Nginx sticky sessions module</a></li>
</ul>
<p>Manually extract nginx-sticky-module under src:</p>
<div class="highlight-python"><pre>cd src
wget http://nginx-sticky-module.googlecode.com/files/nginx-sticky-module-1.0-rc2.tar.gz</pre>
</div>
<p>Then add it do nginx-build part:</p>
<div class="highlight-python"><pre>[nginx-build]
recipe = zc.recipe.cmmi
url = http://sysoev.ru/nginx/nginx-0.7.65.tar.gz
extra_options = --add-module=${buildout:directory}/src/nginx-sticky-module-1.0-rc2</pre>
</div>
<p>Now test reinstalling nginx in buildout:</p>
<div class="highlight-python"><pre>mv parts/nginx-build/ parts/nginx-build-old # Make sure full rebuild is done
bin/buildout install nginx-build</pre>
</div>
<p>See that it compiles without erros. Here is the line of compiling sticky:</p>
<div class="highlight-python"><pre>gcc -c -O -pipe  -O -W -Wall -Wpointer-arith -Wno-unused-parameter -Wunused-function -Wunused-variable -Wunused-value -Werror -g   -I src/core -I src/event -I src/event/modules -I src/os/unix -I objs -I src/http -I src/http/modules -I src/mail \
                -o objs/addon/nginx-sticky-module-1.0-rc2/ngx_http_sticky_module.o \</pre>
</div>
<p>Now add sticky to the load balancer section of nginx config:</p>
<div class="highlight-python"><pre>        [balancer]
        recipe = gocept.nginx
        nginx = nginx-build
        ...
http {
        client_max_body_size 64M;
        upstream zope {
                sticky;
                server ${hosts:client1}:${ports:client1} max_fails=3 fail_timeout=30s;
                server ${hosts:client2}:${ports:client2} max_fails=3 fail_timeout=30s;
                server ${hosts:client3}:${ports:client3} max_fails=3 fail_timeout=30s;
        }</pre>
</div>
<p>Reinstall nginx balaner configs and start-up scripts:</p>
<div class="highlight-python"><pre>bin/buildout install balancer</pre>
</div>
<p>See that generated configuration is ok:</p>
<div class="highlight-python"><pre>bin/nginx-balancer configtest</pre>
</div>
<p>Restart Nginx:</p>
<div class="highlight-python"><pre>bin/nginx-balancer stop ;bin/nginx-balancer start</pre>
</div>
<p>Check that some (non-anonymous) page has route cookie set:</p>
<div class="highlight-python"><pre>Huiske-iMac:tmp moo$ wget -S http://yoursite.com/sisalto/saariselka-infoa
--2011-03-21 21:31:40--  http://yoursite.com/sisalto/saariselka-infoa
Resolving yoursite.com (yoursite.com)... 12.12.12.12
Connecting to yoursite.com (yoursite.com)|12.12.12.12|:80... connected.
HTTP request sent, awaiting response...
  HTTP/1.1 200 OK
  Server: nginx/0.7.65
  Content-Type: text/html;charset=utf-8
  Set-Cookie: route=7136de9c531fcda112f24c3f32c3f52f
  Content-Language: fi
  Expires: Sat, 1 Jan 2000 00:00:00 GMT
  Set-Cookie: I18N_LANGUAGE="fi"; Path=/
  Content-Length: 41471
  Date: Mon, 21 Mar 2011 19:31:40 GMT
  X-Varnish: 1979481774
  Age: 0
  Via: 1.1 varnish
  Connection: keep-alive</pre>
</div>
<p>Now test it by doing session related activity and see that your shopping cart is not &quot;lost&quot;.</p>
<p>More info</p>
<ul class="simple">
<li><a class="reference external" href="http://code.google.com/p/nginx-sticky-module/source/browse/trunk/README">http://code.google.com/p/nginx-sticky-module/source/browse/trunk/README</a></li>
<li><a class="reference external" href="http://nathanvangheem.com/news/nginx-with-built-in-load-balancing-and-caching">http://nathanvangheem.com/news/nginx-with-built-in-load-balancing-and-caching</a></li>
</ul>
</div>
</div>
<div class="section" id="securing-plone-sites-with-https-and-nginx">
<h2><a class="toc-backref" href="#id18">Securing Plone-Sites with https and nginx</a><a class="headerlink" href="#securing-plone-sites-with-https-and-nginx" title="Permalink to this headline">¶</a></h2>
<p>For instructions how to use ssl for all authenticated traffic see this blog-post:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.starzel.de/blog/securing-plone-sites-with-https-and-nginx">http://www.starzel.de/blog/securing-plone-sites-with-https-and-nginx</a></li>
</ul>
</div>
</div>

  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<p class="logo"><a href="../index.html"><img src="../_static/plone-icon-64.png" />
</a></p>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Nginx</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#buildout-and-recipe">Buildout and recipe</a></li>
<li><a class="reference internal" href="#config-test">Config test</a></li>
<li><a class="reference internal" href="#deployment-configuration">Deployment configuration</a></li>
<li><a class="reference internal" href="#killing-loose-nginx">Killing loose Nginx</a></li>
<li><a class="reference internal" href="#debugging-nginx">Debugging Nginx</a></li>
<li><a class="reference internal" href="#www-redirect">www-redirect</a></li>
<li><a class="reference internal" href="#permanent-redirect">Permanent redirect</a><ul>
<li><a class="reference internal" href="#cleaning-up-query-string">Cleaning up query string</a></li>
<li><a class="reference internal" href="#matching-incoming-query-string">Matching incoming query string</a></li>
<li><a class="reference internal" href="#more-info">More info</a></li>
</ul>
</li>
<li><a class="reference internal" href="#make-nginx-aware-where-the-request-came-from">Make NGINX aware where the request came from</a></li>
<li><a class="reference internal" href="#php-with-nginx-and-php-fpm">PHP with NGINX and PHP-FPM</a></li>
<li><a class="reference internal" href="#ssi-server-side-include">SSI - server side include</a></li>
<li><a class="reference internal" href="#session-affinity">Session affinity</a><ul>
<li><a class="reference internal" href="#by-using-ip-addresses">By using IP addresses</a></li>
<li><a class="reference internal" href="#by-using-cookies">By using cookies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#securing-plone-sites-with-https-and-nginx">Securing Plone-Sites with https and nginx</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="varnish.html"
                        title="previous chapter">Varnish</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="deliverance.html"
                        title="next chapter">Deliverance</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/hosting/nginx.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="deliverance.html" title="Deliverance"
             >next</a> |</li>
        <li class="right" >
          <a href="varnish.html" title="Varnish"
             >previous</a> |</li>
        <li><a href="../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Hosting</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2010 mFabrik Research Oy and Plone community contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>


  </body>
</html>