<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>How to update schemas for already registered portlets &mdash; Plone Community Managed Developer Manual v1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/plone.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Plone Community Managed Developer Manual v1.0 documentation" href="../../index.html" />
    <link rel="up" title="Appendix: Practicals" href="index.html" />
    <link rel="next" title="How to make portlets availability configurable via adapters" href="available_adapter.html" />
    <link rel="prev" title="Moving portlet assignments from one item to another" href="moving.html" />
<script language="javascript">
//<![CDATA[

Documentation.addTranslations({"locale": "fr", "plural_expr": "(n > 1)", "messages": {"See the definition": "Voir la d\u00e9finition"}});

// See http://disqus.disqus.com/general_integration_help/
var disqus_developer = 1;
if (document.location.protocol == 'http:') {
    disqus_developer = 0;
}

// Some HTML/CSS transforms we can't do in pure CSS (waiting for CSS3 support)
$(document).ready(function () {

    // Style of .. verisonmodified:: , .. versionadded:: ...
    $('p:has(span.versionmodified)').addClass('p-versionmodified');

    // Style of the TOC tree
    $('ul:has(li.toctree-l1)').addClass('toctree');

    // Decorate links to other sites
    $('a[class~=external]').attr('target', '_blank');

    // Glossary terms
    $('em.xref').attr('title', _('See the definition'));

    // We need to have all <pre> in a <div class="highlight"> to mimic pygments
    // to work around a pygments (?) bug
    var suffixes = {cfg: null, python:null};
    for (var suffix in suffixes) {
        var pattern = 'div.highlight-' + suffix + ' > pre';
        $(pattern).wrap('<div class="highlight" />');
    }
    return true;
});
//]]>
</script>

  </head>
  <body>
<!--[if lte IE 6]>
<style type="text/css">
#ie6msg{border:3px solid #090; margin:8px 0; background:#cfc; color:#000;}
#ie6msg h4{margin:8px; padding:0;}
#ie6msg p{margin:8px; padding:0;}
#ie6msg p a.getie8{font-weight:bold; color:#006;}
#ie6msg p a.ie6expl{font-weight:normal; color:#006;}
</style>
<div id="ie6msg">
<h4>Did you know that your browser is out of date?</h4>
<p>If the layout of this site seems ugly, that's because you're actually using
an outdated browser. And we wont put any effort to provide a nice layout to IE6
users.</p>
<p>To get the best possible experience using our website we recommend that you
upgrade your browser to a newer version. The current version
is <a class="getie8"
href="http://upgradeie.s3.amazonaws.com/eng/index.html">Internet Explorer
8</a>. The upgrade is free. If you're using a PC at work you should contact your
IT administrator.</p>
<p>If you want to you may also try some other popular Internet browsers
like <a class="ie6expl"
href="http://getfirefox.com">Firefox</a>, <a class="ie6expl"
href="http://www.google.com/chrome">Chrome</a>, <a class="ie6expl"
href="http://www.opera.com">Opera</a>, or <a class="ie6expl"
href="http://www.apple.com/safari/download/">Safari</a></p>
</div>
<![endif]-->

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="available_adapter.html" title="How to make portlets availability configurable via adapters"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="moving.html" title="Moving portlet assignments from one item to another"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Portlets</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Appendix: Practicals</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="sphinx-content">
    <div class="section" id="how-to-update-schemas-for-already-registered-portlets">
<h1>How to update schemas for already registered portlets<a class="headerlink" href="#how-to-update-schemas-for-already-registered-portlets" title="Permalink to this headline">Â¶</a></h1>
<div class="admonition-description admonition ">
<p class="first admonition-title">Description</p>
<p class="last">This describes how an Portlet schema can be updated for portlets,
which are already registered in the Portal.</p>
</div>
<p>Note: David Glick suggested an really easy fix, so this one might become
obsolete:</p>
<blockquote>
<p>Add the new attribute as a class attribute of the portlet assignment class.
e.g.</p>
<dl class="docutils">
<dt>class Assignment(base.Assignment):</dt>
<dd>image_size = 42</dd>
</dl>
<p>Then existing assignment instances which don't have that attribute will
still get them from the class.</p>
</blockquote>
<p>Once a portlet with a specific schema is registered, the schema cannot easily
be modified. Because zope.formlib will try to get the value for the new field
in the schema when you visit the edit screen, it will throw an error since
there is no attribute for that object yet. So, you have to update every
instance of that specific portlet type and add the missing attributes.</p>
<p>And here is how, in a generic way:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">Products.CMFCore.utils</span> <span class="kn">import</span> <span class="n">getToolByName</span>
<span class="kn">from</span> <span class="nn">plone.portlets.interfaces</span> <span class="kn">import</span> <span class="n">ILocalPortletAssignable</span>
<span class="kn">from</span> <span class="nn">plone.portlets.interfaces</span> <span class="kn">import</span> <span class="n">IPortletManager</span>
<span class="kn">from</span> <span class="nn">plone.portlets.interfaces</span> <span class="kn">import</span> <span class="n">IPortletAssignmentMapping</span>
<span class="kn">from</span> <span class="nn">zope.component</span> <span class="kn">import</span> <span class="n">getUtilitiesFor</span><span class="p">,</span> <span class="n">getMultiAdapter</span>

<span class="k">def</span> <span class="nf">update_portlet_schema</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">portlet_interface</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to update a schema of an already registered portlet.</span>
<span class="sd">    @param context: A Plone context.</span>
<span class="sd">    @param portlet_interface: The interface that the portlet implements.</span>
<span class="sd">    @param attribute: The name of the attribute to be added as string.</span>
<span class="sd">    @param value: The value, the attribute should be initialized with.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">urltool</span> <span class="o">=</span> <span class="n">getToolByName</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s">&quot;portal_url&quot;</span><span class="p">)</span>
    <span class="n">site</span> <span class="o">=</span> <span class="n">urltool</span><span class="o">.</span><span class="n">getPortalObject</span><span class="p">()</span>

    <span class="n">cat</span> <span class="o">=</span> <span class="n">getToolByName</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="s">&#39;portal_catalog&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;object_provides&#39;</span><span class="p">:</span> <span class="n">ILocalPortletAssignable</span><span class="o">.</span><span class="n">__identifier__</span><span class="p">}</span>
    <span class="n">all_brains</span> <span class="o">=</span> <span class="n">cat</span><span class="p">(</span><span class="o">**</span><span class="n">query</span><span class="p">)</span>
    <span class="n">all_content</span> <span class="o">=</span> <span class="p">[</span><span class="n">brain</span><span class="o">.</span><span class="n">getObject</span><span class="p">()</span> <span class="k">for</span> <span class="n">brain</span> <span class="ow">in</span> <span class="n">all_brains</span><span class="p">]</span>
    <span class="n">all_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">all_content</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">manager_name</span><span class="p">,</span> <span class="n">manager</span> <span class="ow">in</span> <span class="n">getUtilitiesFor</span><span class="p">(</span><span class="n">IPortletManager</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">content</span><span class="p">):</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="n">getMultiAdapter</span><span class="p">((</span><span class="n">content</span><span class="p">,</span> <span class="n">manager</span><span class="p">),</span> <span class="n">IPortletAssignmentMapping</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">portlet_interface</span><span class="o">.</span><span class="n">providedBy</span><span class="p">(</span><span class="n">assignment</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">assignment</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>Just pass the function update_portlet_schema any plone content context (e.g.
the portlet root object itself), the portlet's schema interface which was
modified, the attribute name as string and the value which should set
initially. Done.</p>
<p>You can find this function among other useful tools in the package
<a class="reference external" href="http://pypi.python.org/pypi/collective.setuphandlertools">collective.setuphandlertools</a> and on <a class="reference external" href="https://github.com/collective/collective.setuphandlertools">github</a>.</p>
<p>A fix, so that zope.formlib accepts schema updates is beeing discussed in the
zope mailing list (see <a class="reference external" href="http://www.gossamer-threads.com/lists/zope/dev/230105">here</a>).</p>
</div>

  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<p class="logo"><a href="../../index.html"><img src="../../_static/plone-icon-64.png" />
</a></p>

  <h4>Previous topic</h4>
  <p class="topless"><a href="moving.html"
                        title="previous chapter">Moving portlet assignments from one item to another</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="available_adapter.html"
                        title="next chapter">How to make portlets availability configurable via adapters</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/portlets/appendix/schema_update.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="available_adapter.html" title="How to make portlets availability configurable via adapters"
             >next</a> |</li>
        <li class="right" >
          <a href="moving.html" title="Moving portlet assignments from one item to another"
             >previous</a> |</li>
        <li><a href="../../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Portlets</a> &raquo;</li>
          <li><a href="index.html" >Appendix: Practicals</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2010 mFabrik Research Oy and Plone community contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>


  </body>
</html>