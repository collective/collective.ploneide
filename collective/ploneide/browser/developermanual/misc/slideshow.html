<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Slidehows and carousels &mdash; Plone Community Managed Developer Manual v1.0 documentation</title>
    <link rel="stylesheet" href="../_static/plone.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Plone Community Managed Developer Manual v1.0 documentation" href="../index.html" />
    <link rel="up" title="Miscellaneous information" href="index.html" />
    <link rel="next" title="Upgrade tips" href="upgrade.html" />
    <link rel="prev" title="Facebook integration" href="facebook.html" />
<script language="javascript">
//<![CDATA[

Documentation.addTranslations({"locale": "fr", "plural_expr": "(n > 1)", "messages": {"See the definition": "Voir la d\u00e9finition"}});

// See http://disqus.disqus.com/general_integration_help/
var disqus_developer = 1;
if (document.location.protocol == 'http:') {
    disqus_developer = 0;
}

// Some HTML/CSS transforms we can't do in pure CSS (waiting for CSS3 support)
$(document).ready(function () {

    // Style of .. verisonmodified:: , .. versionadded:: ...
    $('p:has(span.versionmodified)').addClass('p-versionmodified');

    // Style of the TOC tree
    $('ul:has(li.toctree-l1)').addClass('toctree');

    // Decorate links to other sites
    $('a[class~=external]').attr('target', '_blank');

    // Glossary terms
    $('em.xref').attr('title', _('See the definition'));

    // We need to have all <pre> in a <div class="highlight"> to mimic pygments
    // to work around a pygments (?) bug
    var suffixes = {cfg: null, python:null};
    for (var suffix in suffixes) {
        var pattern = 'div.highlight-' + suffix + ' > pre';
        $(pattern).wrap('<div class="highlight" />');
    }
    return true;
});
//]]>
</script>

  </head>
  <body>
<!--[if lte IE 6]>
<style type="text/css">
#ie6msg{border:3px solid #090; margin:8px 0; background:#cfc; color:#000;}
#ie6msg h4{margin:8px; padding:0;}
#ie6msg p{margin:8px; padding:0;}
#ie6msg p a.getie8{font-weight:bold; color:#006;}
#ie6msg p a.ie6expl{font-weight:normal; color:#006;}
</style>
<div id="ie6msg">
<h4>Did you know that your browser is out of date?</h4>
<p>If the layout of this site seems ugly, that's because you're actually using
an outdated browser. And we wont put any effort to provide a nice layout to IE6
users.</p>
<p>To get the best possible experience using our website we recommend that you
upgrade your browser to a newer version. The current version
is <a class="getie8"
href="http://upgradeie.s3.amazonaws.com/eng/index.html">Internet Explorer
8</a>. The upgrade is free. If you're using a PC at work you should contact your
IT administrator.</p>
<p>If you want to you may also try some other popular Internet browsers
like <a class="ie6expl"
href="http://getfirefox.com">Firefox</a>, <a class="ie6expl"
href="http://www.google.com/chrome">Chrome</a>, <a class="ie6expl"
href="http://www.opera.com">Opera</a>, or <a class="ie6expl"
href="http://www.apple.com/safari/download/">Safari</a></p>
</div>
<![endif]-->

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="upgrade.html" title="Upgrade tips"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="facebook.html" title="Facebook integration"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Miscellaneous information</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="sphinx-content">
    <div class="section" id="slidehows-and-carousels">
<h1>Slidehows and carousels<a class="headerlink" href="#slidehows-and-carousels" title="Permalink to this headline">¶</a></h1>
<div class="admonition-description admonition ">
<p class="first admonition-title">Description</p>
<p class="last">How to use annotation design pattern to store
arbitary values on Python objects (Plone site,
HTTP request) for storage and caching purposes.</p>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#migrate-products-slideshow-to-products-carousel" id="id2">Migrate Products.Slideshow to Products.Carousel</a></li>
<li><a class="reference internal" href="#setting-every-carousel-widths-on-the-site" id="id3">Setting every carousel widths on the site</a><ul>
<li><a class="reference internal" href="#ajax-full-size-image-loading-for-album-views" id="id4">AJAX full-size image loading for album views</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Header slideshows</p>
<ul class="simple">
<li><a class="reference external" href="http://plone.org/products/carousel/">Products.Carousel</a></li>
</ul>
<p>AJAX'y image pop-ups</p>
<ul class="simple">
<li><a class="reference external" href="http://plone.org/products/pipbox">http://plone.org/products/pipbox</a></li>
</ul>
</div>
<div class="section" id="migrate-products-slideshow-to-products-carousel">
<h2><a class="toc-backref" href="#id2">Migrate Products.Slideshow to Products.Carousel</a><a class="headerlink" href="#migrate-products-slideshow-to-products-carousel" title="Permalink to this headline">¶</a></h2>
<p>Here is a sample migration code to transform your site
from one add-on to another.</p>
<p>We create a migration view which you can call by typing in view name
manually to web browser.</p>
<p>This code will</p>
<ul class="simple">
<li>Scan site for folders which have Slideshow add-on enabled. In this example we check against a predefined list (scanned earlier),
but the code contains example how to detect slideshow folders</li>
<li>Create Carousel for those folders</li>
<li>Create corresponds Carousel Banners for all Slideshow Image content items</li>
<li>Set some Carousel settings</li>
<li>Make sure that we invalidate cache for content items going through migration</li>
<li>Set a new default view for folders which were using slideshow</li>
</ul>
<p>Also</p>
<ul class="simple">
<li>After inspecting the process was ok you can delete migrated images</li>
</ul>
<p>carousel.py:</p>
<div class="highlight-python"><pre>"""

    Migrate slideshow to carousel.

    Usage:

    http://yoursite/@@migrate_carousel - the process can be repeated with adjusted settings. It's non-descructive.

    http://yoursite/@@delete_migrated_slideshow_images

"""

import logging
from StringIO import StringIO
from Products.Five.browser import BrowserView

from zope.component import getUtility, getMultiAdapter
from zope.app.component.hooks import setHooks, setSite, getSite

from zope.interface import alsoProvides
from Products.Five import BrowserView
from Products.CMFCore.utils import getToolByName
from Products.Carousel.interfaces import ICarouselFolder
from Products.Carousel.utils import addPermissionsForRole
from Products.Carousel.config import CAROUSEL_ID
from Products.Carousel.interfaces import ICarousel, ICarouselSettings

from Products.slideshowfolder.interfaces import ISlideShowSettings, ISlideShowView, IFolderSlideShowView, ISlideShowFolder, ISlideshowImage

logger = logging.getLogger("Slideshow Migrator")

FOLDER_PATHS_TO_MIGRATE="""
('', 'site', 'folder1')
('', 'site', 'folder2')
('', 'site', 'folder2', 'subfolder')
"""

class MigrateSlideshowToCarousel(BrowserView):
    """
    Migrate collective.slideshow to Products.Carousel
    """


    def startCapture(self, newLogLevel = None):
        """ Start capturing log output to a string buffer.

        http://docs.python.org/release/2.6/library/logging.html

        @param newLogLevel: Optionally change the global logging level, e.g. logging.DEBUG
        """
        self.buffer = StringIO()

        print &gt;&gt; self.buffer, "Log output"

        rootLogger = logging.getLogger()

        if newLogLevel:
            self.oldLogLevel = rootLogger.getEffectiveLevel()
            rootLogger.setLevel(newLogLevel)
        else:
            self.oldLogLevel = None

        self.logHandler = logging.StreamHandler(self.buffer)
        formatter = logging.Formatter("%(asctime)s - %(name)s - %(levelname)s - %(message)s")
        self.logHandler.setFormatter(formatter)
        rootLogger.addHandler(self.logHandler)

    def stopCapture(self):
        """ Stop capturing log output.

        @return: Collected log output as string
        """

        # Remove our handler
        rootLogger = logging.getLogger()

        # Restore logging level (if any)
        if self.oldLogLevel:
            rootLogger.setLevel(self.oldLogLevel)

        rootLogger.removeHandler(self.logHandler)

        self.logHandler.flush()
        self.buffer.flush()

        return self.buffer.getvalue()


    def getImages(self, folder):
        """ Get all ATImages in a folder """
        for obj in folder.objectValues():
            if obj.portal_type == "Image":
                yield obj

    def getOrCreateCarousel(self, folder):
        """ Copied from Products.Carousel manager.py """


        if hasattr(folder.aq_base, CAROUSEL_ID):
            logger.info("Using existing carousel in " + str(folder))
            carousel = getattr(folder, CAROUSEL_ID)
        else:
            logger.info("Creating carousel in " + str(folder))
            pt = getToolByName(folder, 'portal_types')
            newid = pt.constructContent('Folder', folder, 'carousel', title='Carousel Banners', excludeFromNav=True)
            carousel = getattr(folder, newid)

            # mark the new folder as a Carousel folder
            alsoProvides(carousel, ICarouselFolder)

            # make sure Carousel banners are addable within the new folder
            addPermissionsForRole(carousel, 'Manager', ('Carousel: Add Carousel Banner',))

            # make sure *only* Carousel banners are addable
            carousel.setConstrainTypesMode(1)
            carousel.setLocallyAllowedTypes(['Carousel Banner'])
            carousel.setImmediatelyAddableTypes(['Carousel Banner'])

        return carousel

    def imageToCarouselBanner(self, image, carousel):
        """
        Convert ATImage to Carousel Banner content item.
        """

        logger.info("Migrating slideshow image:" + str(image.getId()))

        id = image.getId()

        if not id in carousel.objectIds():
            carousel.invokeFactory("Carousel Banner", id, title=image.Title())
        else:
            logger.info("Carousel image already existed " + str(image))

        banner = carousel[id]

        # Copy over image field from ATImage content type
        banner.setImage(image.getImage())


        # Set a hidden flag which allows us later to delete images
        image._migrated_to_carousel = True

         from Products.CMFCore.WorkflowCore import WorkflowException

        workflowTool = getToolByName(banner, "portal_workflow")
        try:
            workflowTool.doActionFor(banner, "publish")
            logger.info("Published " + banner.getId())
        except WorkflowException:
            # a workflow exception is risen if the state transition is not available
            # (the sampleProperty content is in a workflow state which
            # does not have a "submit" transition)
            logger.info("Could not publish:" + str(banner.getId()) + " already published?")
            pass

    def setupCarousel(self, carousel_folder):
        """
        Set-up custom carousel settings for all carousels.
        """

        logger.info("Setting carousel settings for:" + carousel_folder.absolute_url())

        settings = ICarouselSettings(carousel_folder)

        settings.width = 640
        settings.height = 450
        settings.pager_template = u'@@pager-none'
        settings.default_page_only = False
        settings.element_id = "karuselli"
        settings.transition_delay = 5.0
        settings.banner_elements = [ u"image" ]


    def migrateFolder(self, folder):
        """ Migrate one folder from Slideshow to Products.Carousel
        """
        logger.info("Migrating folder:" + str(folder))

        carousel = self.getOrCreateCarousel(folder)

        self.setupCarousel(carousel)

        images = self.getImages(folder)
        for image in images:
            self.imageToCarouselBanner(image, carousel)

        # This will toggle cache refresh for the object
        # if Products.CacheSetup is used -&gt; should invalidate template cache.
        # Not necessary if Products.CacheSetup is not installed.
        folder.setTitle(folder.Title())
        folder.reindexObject()

        # Toggle folder away from slideshow view
        # empty_view is our custom view which does not list folder contents
        folder.setLayout("empty_view")

        # Set a marker flag in the case we need to play around with these
        # folderes programmatically in the future
        folder._migrated_to_carousel = True




    def migrate(self):
        """
        Run the migration process for one Plone site.
        """

        brains = self.context.portal_catalog(portal_type="Folder")

        # Use predefined report of slideshow folder on old site
        # Alternative: detect slideshow folders as shown below
        carousel_folders  = FOLDER_PATHS_TO_MIGRATE.split("\n")

        for b in brains:

            obj = b.getObject()

            path = str(obj.getPhysicalPath())

            # Alternative: if you don't have fixed list check here if getattr(obj, "default_view", "") == "slideshow_view"
            if path in carousel_folders:
                self.migrateFolder(obj)


    def __call__(self):
        """ Process the form.

        Process the form, log the output and show the output to the user.
        """

        self.logs = None


        try:
            self.startCapture(logging.DEBUG)

            logger.info("Starting full site migration")

            # Do the long running,
            # lots of logging stuff
            self.migrate()

            logger.info("Succesfully done")


        except Exception, e:
            # Show friendly error message
            logger.exception(e)

        # Put log output for the page template access
        self.logs = self.stopCapture()

        return self.logs

class DeleteMigratedImages(BrowserView):
    """
    Delete all slideshow image files which have been migrated to carousel banners.

    By doing migration in two phases allows us to adjust the process in the case it goes wrong.
    """

    def __call__(self):
        """

        """

        self.buffer = StringIO()

        print &gt;&gt; self.buffer, "Log output"

        brains = self.context.portal_catalog(portal_type="Image")
        for b in brains:
            obj = b.getObject()
            if getattr(obj, "_migrated_to_carousel", False) == True:
                print &gt;&gt; self.buffer, "Deleting migrated Image " + obj.getId()
                id = obj.getId()
                parent = obj.aq_parent
                parent.manage_delObjects([id])

        print &gt;&gt; self.buffer, "All migrated images deleted"

        return self.buffer.getvalue()</pre>
</div>
<p>ZCML bits:</p>
<div class="highlight-python"><pre>&lt;browser:page
  for="*"
  name="migrate_carousel"
  permission="cmf.ManagePortal"
  class=".carousel.MigrateSlideshowToCarousel"
  /&gt;

&lt;browser:page
  for="*"
  name="delete_migrated_slideshow_images"
  permission="cmf.ManagePortal"
  class=".carousel.DeleteMigratedImages"
  /&gt;</pre>
</div>
</div>
<div class="section" id="setting-every-carousel-widths-on-the-site">
<h2><a class="toc-backref" href="#id3">Setting every carousel widths on the site</a><a class="headerlink" href="#setting-every-carousel-widths-on-the-site" title="Permalink to this headline">¶</a></h2>
<p>Another example to manipulate Products.Carousel.
This script will update all carousel settings
on the site to have new image width.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SetCarouselWidths</span><span class="p">(</span><span class="n">BrowserView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set width to all carousels on the site.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Log output&quot;</span>

        <span class="n">brains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">portal_catalog</span><span class="p">(</span><span class="n">portal_type</span><span class="o">=</span><span class="s">&quot;Folder&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">brains</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">getObject</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&quot;carousel&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">objectIds</span><span class="p">():</span>
                <span class="n">carousel</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s">&quot;carousel&quot;</span><span class="p">]</span>
                <span class="c"># Carousel installed on this folder</span>
                <span class="n">settings</span> <span class="o">=</span> <span class="n">ICarouselSettings</span><span class="p">(</span><span class="n">carousel</span><span class="p">)</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Setting width for &quot;</span> <span class="o">+</span> <span class="n">carousel</span><span class="o">.</span><span class="n">absolute_url</span><span class="p">()</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">680</span>

        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;All carousels updated&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>
</div>
<p>ZCML</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;browser:page</span>
  <span class="na">for=</span><span class="s">&quot;*&quot;</span>
  <span class="na">name=</span><span class="s">&quot;set_carousel_widths&quot;</span>
  <span class="na">permission=</span><span class="s">&quot;cmf.ManagePortal&quot;</span>
  <span class="na">class=</span><span class="s">&quot;.carousel.SetCarouselWidths&quot;</span>
  <span class="nt">/&gt;</span>
</pre></div>
</div>
<div class="section" id="ajax-full-size-image-loading-for-album-views">
<h3><a class="toc-backref" href="#id4">AJAX full-size image loading for album views</a><a class="headerlink" href="#ajax-full-size-image-loading-for-album-views" title="Permalink to this headline">¶</a></h3>
<p>Plone album views can be easily converted to pop-up image viewing with PipBox.</p>
<p>Put the following to portal_properties / pipbox_properties</p>
<p>Album view &lt;a&gt; click handler:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="nb">type</span><span class="p">:</span><span class="s">&#39;overlay&#39;</span><span class="p">,</span> <span class="n">subtype</span><span class="p">:</span><span class="s">&#39;image&#39;</span><span class="p">,</span> <span class="n">selector</span><span class="p">:</span><span class="s">&#39;.photoAlbumEntry a&#39;</span><span class="p">,</span> <span class="n">urlmatch</span><span class="p">:</span><span class="s">&#39;/view$&#39;</span><span class="p">,</span> <span class="n">urlreplace</span><span class="p">:</span><span class="s">&#39;/image_large&#39;</span><span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">portal_javascript must be in debug mode while testing different Products.PipBox handlers.</p>
</div>
</div>
</div>
</div>

  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<p class="logo"><a href="../index.html"><img src="../_static/plone-icon-64.png" />
</a></p>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Slidehows and carousels</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#migrate-products-slideshow-to-products-carousel">Migrate Products.Slideshow to Products.Carousel</a></li>
<li><a class="reference internal" href="#setting-every-carousel-widths-on-the-site">Setting every carousel widths on the site</a><ul>
<li><a class="reference internal" href="#ajax-full-size-image-loading-for-album-views">AJAX full-size image loading for album views</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="facebook.html"
                        title="previous chapter">Facebook integration</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="upgrade.html"
                        title="next chapter">Upgrade tips</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/misc/slideshow.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="upgrade.html" title="Upgrade tips"
             >next</a> |</li>
        <li class="right" >
          <a href="facebook.html" title="Facebook integration"
             >previous</a> |</li>
        <li><a href="../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Miscellaneous information</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2010 mFabrik Research Oy and Plone community contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>


  </body>
</html>