<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Annotations &mdash; Plone Community Managed Developer Manual v1.0 documentation</title>
    <link rel="stylesheet" href="../_static/plone.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Plone Community Managed Developer Manual v1.0 documentation" href="../index.html" />
    <link rel="up" title="Miscellaneous information" href="index.html" />
    <link rel="next" title="Normalizing ids" href="normalizing_ids.html" />
    <link rel="prev" title="Sending email" href="email.html" />
<script language="javascript">
//<![CDATA[

Documentation.addTranslations({"locale": "fr", "plural_expr": "(n > 1)", "messages": {"See the definition": "Voir la d\u00e9finition"}});

// See http://disqus.disqus.com/general_integration_help/
var disqus_developer = 1;
if (document.location.protocol == 'http:') {
    disqus_developer = 0;
}

// Some HTML/CSS transforms we can't do in pure CSS (waiting for CSS3 support)
$(document).ready(function () {

    // Style of .. verisonmodified:: , .. versionadded:: ...
    $('p:has(span.versionmodified)').addClass('p-versionmodified');

    // Style of the TOC tree
    $('ul:has(li.toctree-l1)').addClass('toctree');

    // Decorate links to other sites
    $('a[class~=external]').attr('target', '_blank');

    // Glossary terms
    $('em.xref').attr('title', _('See the definition'));

    // We need to have all <pre> in a <div class="highlight"> to mimic pygments
    // to work around a pygments (?) bug
    var suffixes = {cfg: null, python:null};
    for (var suffix in suffixes) {
        var pattern = 'div.highlight-' + suffix + ' > pre';
        $(pattern).wrap('<div class="highlight" />');
    }
    return true;
});
//]]>
</script>

  </head>
  <body>
<!--[if lte IE 6]>
<style type="text/css">
#ie6msg{border:3px solid #090; margin:8px 0; background:#cfc; color:#000;}
#ie6msg h4{margin:8px; padding:0;}
#ie6msg p{margin:8px; padding:0;}
#ie6msg p a.getie8{font-weight:bold; color:#006;}
#ie6msg p a.ie6expl{font-weight:normal; color:#006;}
</style>
<div id="ie6msg">
<h4>Did you know that your browser is out of date?</h4>
<p>If the layout of this site seems ugly, that's because you're actually using
an outdated browser. And we wont put any effort to provide a nice layout to IE6
users.</p>
<p>To get the best possible experience using our website we recommend that you
upgrade your browser to a newer version. The current version
is <a class="getie8"
href="http://upgradeie.s3.amazonaws.com/eng/index.html">Internet Explorer
8</a>. The upgrade is free. If you're using a PC at work you should contact your
IT administrator.</p>
<p>If you want to you may also try some other popular Internet browsers
like <a class="ie6expl"
href="http://getfirefox.com">Firefox</a>, <a class="ie6expl"
href="http://www.google.com/chrome">Chrome</a>, <a class="ie6expl"
href="http://www.opera.com">Opera</a>, or <a class="ie6expl"
href="http://www.apple.com/safari/download/">Safari</a></p>
</div>
<![endif]-->

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="normalizing_ids.html" title="Normalizing ids"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="email.html" title="Sending email"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Miscellaneous information</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="sphinx-content">
    <div class="section" id="annotations">
<h1>Annotations<a class="headerlink" href="#annotations" title="Permalink to this headline">¶</a></h1>
<div class="admonition-description admonition ">
<p class="first admonition-title">Description</p>
<p class="last">How to use annotation design pattern to store
arbitary values on Python objects (Plone site,
HTTP request) for storage and caching purposes.</p>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#http-request-example" id="id2">HTTP request example</a></li>
<li><a class="reference internal" href="#content-annotations" id="id3">Content annotations</a></li>
<li><a class="reference internal" href="#cleaning-up-content-annotations" id="id4">Cleaning up content annotations</a></li>
<li><a class="reference internal" href="#other-resources" id="id5">Other resources</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Annotations is conflict-free way to stick attributes on arbitary Python objects.</p>
<p>Plone uses annotations for</p>
<ul class="simple">
<li>Storing field data in Archetypes (Annotation storage)</li>
<li>Caching values on HTTP request object (plone.memoize cache decorators)</li>
<li>Storing settings information in portal object (various add-on products)</li>
</ul>
<p>See <cite>zope.annotation package &lt;http://pypi.python.org/pypi/zope.annotation/3.4.1&gt;</cite>.</p>
</div>
<div class="section" id="http-request-example">
<h2><a class="toc-backref" href="#id2">HTTP request example</a><a class="headerlink" href="#http-request-example" title="Permalink to this headline">¶</a></h2>
<p>Store cached values on HTTP request during the life cycle of one request processing.
This allows you to cache computed values if the computation function is called
from the different, unrelated, code paths.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">zope.annotation.interfaces</span> <span class="kn">import</span> <span class="n">IAnnotations</span>

<span class="c"># Non-conflicting key</span>
<span class="n">KEY</span> <span class="o">=</span> <span class="s">&quot;mypackage.something&quot;</span>

<span class="n">annotations</span> <span class="o">=</span> <span class="n">IAnnotations</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="n">value</span> <span class="o">=</span> <span class="n">annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">KEY</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># Compute value and store it on request object for further look-ups</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">[</span><span class="n">KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">something</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="content-annotations">
<h2><a class="toc-backref" href="#id3">Content annotations</a><a class="headerlink" href="#content-annotations" title="Permalink to this headline">¶</a></h2>
<p>If you want to extend any Plone content to contain &quot;custom&quot; settings annotations
is the recommended way to do it.</p>
<ul class="simple">
<li>Your add-on can store its settings in Plone site root object using local utilities or annotations</li>
<li>You can store custom settings on content objects using annotations</li>
</ul>
<p>By default, in content annotations are stored</p>
<ul class="simple">
<li>Assigned portlets and their settings</li>
<li>Archetypes content type fiels using AnnotationStorage (like <tt class="docutils literal"><span class="pre">text</span></tt> field on Document)</li>
<li>Behavior data from <tt class="docutils literal"><span class="pre">plone.behavior</span></tt> package</li>
</ul>
<p>Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Assume context variable refers to some content item</span>

 <span class="c"># Non-conflicting key</span>
<span class="n">KEY</span> <span class="o">=</span> <span class="s">&quot;yourcompany.packagename.magicalcontentnavigationsetting&quot;</span>

<span class="n">annotations</span> <span class="o">=</span> <span class="n">IAnnotations</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="c"># Store some setting on the content item</span>
<span class="n">annotations</span><span class="p">[</span><span class="n">KEY</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
</div>
<div class="section" id="cleaning-up-content-annotations">
<h2><a class="toc-backref" href="#id4">Cleaning up content annotations</a><a class="headerlink" href="#cleaning-up-content-annotations" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you store full Python objects in annotations you need to clean them up during your add-on
uninstallation. Otherwise if Python code is not present you cannot no longer import or export
Plone site (annotations are pickled objects in the database and pickles do no longer work
if the code is not present).</p>
</div>
<p>How to clean up annotations on content objects:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">clean_up_content_annotations</span><span class="p">(</span><span class="n">portal</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove objects from content annotations in Plone site,</span>

<span class="sd">    This is mostly to remove objects which might make the site un-exportable</span>
<span class="sd">    when eggs / Python code has been removed.</span>

<span class="sd">    @param portal: Plone site object</span>

<span class="sd">    @param names: Names of the annotation entries to remove</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">recurse</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recurse through all content on Plone site &quot;&quot;&quot;</span>

        <span class="n">annotations</span> <span class="o">=</span> <span class="n">IAnnotations</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="c">#print  &gt;&gt; output, &quot;Recusring to item:&quot; + str(context)</span>
        <span class="k">print</span> <span class="n">annotations</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">output</span><span class="p">,</span> <span class="s">&quot;Cleaning up annotation </span><span class="si">%s</span><span class="s"> on item </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">absolute_url</span><span class="p">())</span>
                <span class="k">del</span> <span class="n">annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="c"># Make sure that we recurse to real folders only,</span>
        <span class="c"># otherwise contentItems() might be acquired from higher level</span>
        <span class="k">if</span> <span class="n">IFolderish</span><span class="o">.</span><span class="n">providedBy</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">contentItems</span><span class="p">():</span>
                <span class="n">recurse</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="n">recurse</span><span class="p">(</span><span class="n">portal</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
</div>
<div class="section" id="other-resources">
<h2><a class="toc-backref" href="#id5">Other resources</a><a class="headerlink" href="#other-resources" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://plone.org/documentation/tutorial/embrace-and-extend-the-zope-3-way/annotations">http://plone.org/documentation/tutorial/embrace-and-extend-the-zope-3-way/annotations</a></li>
</ul>
</div>
</div>

  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<p class="logo"><a href="../index.html"><img src="../_static/plone-icon-64.png" />
</a></p>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Annotations</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#http-request-example">HTTP request example</a></li>
<li><a class="reference internal" href="#content-annotations">Content annotations</a></li>
<li><a class="reference internal" href="#cleaning-up-content-annotations">Cleaning up content annotations</a></li>
<li><a class="reference internal" href="#other-resources">Other resources</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="email.html"
                        title="previous chapter">Sending email</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="normalizing_ids.html"
                        title="next chapter">Normalizing ids</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/misc/annotations.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="normalizing_ids.html" title="Normalizing ids"
             >next</a> |</li>
        <li class="right" >
          <a href="email.html" title="Sending email"
             >previous</a> |</li>
        <li><a href="../index.html">Plone Community Managed Developer Manual v1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Miscellaneous information</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2010 mFabrik Research Oy and Plone community contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>


  </body>
</html>